<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cổng thanh toán (Mô phỏng)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        .gateway-container {
            width: 100%;
            max-width: 480px;
            margin: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .header {
            background-color: #008fe5;
            color: white;
            padding: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .order-summary {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #fdfdfd;
        }
        .order-summary .label {
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .order-summary .amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
        }
        .order-summary .order-id {
            font-size: 0.85rem;
            color: #555;
            margin-top: 8px;
            word-break: break-all;
        }
        .payment-methods {
            padding: 20px;
        }
        .payment-methods h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 16px;
        }
        .bank-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-height: 220px; 
            overflow-y: auto;  
            padding: 10px;     
            border: 1px solid #eee; 
            border-radius: 8px;
        }
        .bank-list .loader {
            grid-column: 1 / -1; 
            text-align: center;
            color: #777;
            padding: 20px 0;
            font-size: 0.9rem;
        }
        .bank-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
        }
        .bank-item:hover {
            border-color: #008fe5;
            box-shadow: 0 2px 4px rgba(0,143,229,0.2);
        }
        .bank-item.selected {
            border-color: #008fe5;
            background-color: #f0f9ff;
            box-shadow: 0 2px 4px rgba(0,143,229,0.2);
        }
        .bank-item img {
            max-width: 100%;
            max-height: 30px;
            object-fit: contain;
        }
        .card-form {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 6px;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box; 
            font-size: 1rem;
        }
        .form-group input:disabled {
            background-color: #f0f0f0;
            color: #333;
            cursor: not-allowed;
        }
        .char-counter {
            font-size: 0.85rem;
            color: #888;
            text-align: right;
            margin-top: 4px;
            display: none;
        }
        .btn-pay {
            background-color: #4CAF50; 
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 16px;
        }
        .btn-pay:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div class="gateway-container" id="gatewayContainer">
        <div class="header">
            Cổng thanh toán 
        </div>
        
        <div class="order-summary">
            <div class="label">Số tiền thanh toán</div>
            <div class="amount" id="amountDisplay">Đang tải...</div>
            <div class="order-id" id="orderIdDisplay">Đang tải...</div>
        </div>

        <div class="payment-methods">
            <h3>Chọn Ngân hàng </h3>
            <div class="bank-list" id="bankList">
                <p class="loader">Đang tải danh sách ngân hàng...</p>
            </div>

            <div class="card-form" id="cardForm">
                <div class="form-group">
                    <label for="accountNumber">Số tài khoản</label>
                    <input type="text" id="accountNumber" placeholder="Vui lòng chọn ngân hàng" disabled>
                    <div class="char-counter" id="charCounter">0/10</div>
                </div>
                <div class="form-group">
                    <label for="accountName">Tên chủ tài khoản</label>
                    <input type="text" id="accountName" placeholder="Tên sẽ tự động hiển thị" disabled>
                </div>
                <button class="btn-pay" id="confirmPaymentBtn" disabled>Xác nhận thanh toán (Mô phỏng)</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const amountDisplay = document.getElementById('amountDisplay');
            const orderIdDisplay = document.getElementById('orderIdDisplay');
            const bankList = document.getElementById('bankList');
            const confirmBtn = document.getElementById('confirmPaymentBtn');
            const accountNumberInput = document.getElementById('accountNumber'); 
            const accountNameInput = document.getElementById('accountName');
            const gatewayContainer = document.getElementById('gatewayContainer');
            const charCounter = document.getElementById('charCounter');

            // --- BỘ LUẬT MÔ PHỎNG ĐỘ DÀI STK ---
            // (Đã cập nhật MB Bank = 10 số theo STK của bạn)
            const MOCK_BANK_RULES = {
                'VCB': 13,
                'TCB': 14,
                'MB': 10,         // <-- SỬA MB THÀNH 10 SỐ
                'AGRIBANK': 13,
                'BIDV': 10,       
                'VIETINBANK': 12,
                'ACB': 10,       
                'SACOMBANK': 12, 
                'DEFAULT': 12    
            };

            // --- NGÂN HÀNG DỮ LIỆU GIẢ LẬP (TỰ ĐỘNG ĐIỀN TÊN) ---
            // (Đã thêm STK của bạn)
            const FAKE_ACCOUNT_DB = {
                // STK CỦA BẠN:
                '5602007629': 'NGO THANH TRUNG', // BIDV (10 số)
                '0777488240': 'NGO THANH TRUNG', // MB (10 số)
                
                // STK Giả lập khác:
                '0011001234567': 'NGUYEN VAN A',  // VCB (13 số)
                '19012345678901': 'TRAN THI B'    // TCB (14 số)
            };

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            const amount = parseFloat(urlParams.get('amount'));
            const returnUrl = urlParams.get('returnUrl') || '/payment-result.html';

            if (!orderId || !amount) {
                gatewayContainer.innerHTML = '<div class="loader" style="color: red; padding: 20px;">Lỗi: Không tìm thấy thông tin đơn hàng.</div>';
                return;
            }

            // 1. Hiển thị thông tin
            amountDisplay.textContent = amount.toLocaleString('vi-VN') + ' VND';
            orderIdDisplay.textContent = `Mã đơn hàng: ${orderId}`;
            
            // 2. Hàm tải và hiển thị danh sách ngân hàng
            async function loadBanks() {
                try {
                    const response = await fetch('https://api.vietqr.io/v2/banks');
                    if (!response.ok) throw new Error('Không thể tải danh sách ngân hàng');
                    
                    const data = await response.json();
                    if (!data.data || data.data.length === 0) throw new Error('Không tìm thấy ngân hàng nào');

                    bankList.innerHTML = ''; 

                    // 3. Vẽ từng ngân hàng ra
                    data.data.forEach(bank => {
                        const bankEl = document.createElement('div');
                        bankEl.className = 'bank-item';
                        bankEl.dataset.bankId = bank.shortName;
                        bankEl.title = bank.name;
                        
                        const cardLength = MOCK_BANK_RULES[bank.shortName] || MOCK_BANK_RULES['DEFAULT']; 
                        bankEl.dataset.cardLength = cardLength;

                        bankEl.innerHTML = `<img src="${bank.logo}" alt="${bank.shortName}">`;
                        
                        bankEl.addEventListener('click', () => {
                            document.querySelectorAll('.bank-item').forEach(item => item.classList.remove('selected'));
                            bankEl.classList.add('selected');
                            
                            accountNumberInput.disabled = false;
                            
                            const currentLength = bankEl.dataset.cardLength;
                            accountNumberInput.placeholder = `Nhập ${currentLength} số tài khoản`;
                            
                            charCounter.textContent = `0/${currentLength}`;
                            charCounter.style.display = 'block';
                            
                            accountNumberInput.value = ''; 
                            accountNameInput.value = '';  
                            accountNameInput.disabled = true; 
                            accountNameInput.placeholder = 'Tên sẽ tự động hiển thị';
                            
                            validateForm();
                        });
                        bankList.appendChild(bankEl);
                    });

                } catch (err) {
                    bankList.innerHTML = `<p class="loader" style="color: red;">${err.message}</p>`;
                }
            }

            // 4. Validate form (Cập nhật logic)
            function validateForm() {
                const selectedBank = document.querySelector('.bank-item.selected');
                if (!selectedBank) {
                    confirmBtn.disabled = true;
                    return;
                }
                
                const requiredLength = parseInt(selectedBank.dataset.cardLength);
                
                accountNumberInput.value = accountNumberInput.value.replace(/\D/g, ''); 
                
                if (accountNumberInput.value.length > requiredLength) {
                    accountNumberInput.value = accountNumberInput.value.substring(0, requiredLength);
                }
                
                charCounter.textContent = `${accountNumberInput.value.length}/${requiredLength}`;
                
                const currentSTK = accountNumberInput.value.trim();
                const foundName = FAKE_ACCOUNT_DB[currentSTK];

                if (foundName) {
                    accountNameInput.value = foundName;
                    accountNameInput.disabled = true; 
                } else {
                    accountNameInput.value = ''; 
                    
                    if (currentSTK.length === requiredLength) {
                        accountNameInput.placeholder = 'STK không có trong DB (Mô phỏng)';
                        accountNameInput.disabled = true; 
                    } else {
                        accountNameInput.placeholder = 'Tên sẽ tự động hiển thị';
                        accountNameInput.disabled = true; 
                    }
                }
                
                const isAccountNumberValid = currentSTK.length === requiredLength;
                const isAccountNameValid = accountNameInput.value.trim().length > 0;
                
                confirmBtn.disabled = !isAccountNumberValid || !isAccountNameValid;
            }

            accountNumberInput.addEventListener('input', validateForm);

            // 5. Xử lý nút thanh toán
         // 5. Xử lý nút thanh toán (GỬI KÈM STK VÀ BANK)
            confirmBtn.addEventListener('click', async () => {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Đang xử lý...';
                try {
                    // Lấy thông tin ngân hàng và STK
                    const selectedBankEl = document.querySelector('.bank-item.selected');
                    const bankName = selectedBankEl ? selectedBankEl.dataset.bankId : 'UNKNOWN'; // Lấy tên viết tắt, ví dụ: 'BIDV'
                    const accountNo = accountNumberInput.value;

                    // *** GỌI API VÀ GỬI DỮ LIỆU MỚI ***
                    const response = await fetch('/api/payment/confirm-online', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // Gửi kèm bankName và accountNo
                        body: JSON.stringify({ 
                            orderId: orderId,
                            bankName: bankName,
                            accountNo: accountNo
                        }) 
                    });
                    
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);

                    // Chuyển về trang kết quả cuối cùng
                    window.location.href = `${returnUrl}?orderId=${orderId}&status=0&message=ThanhToanThanhCong`;

                } catch (err) {
                    gatewayContainer.innerHTML = `<div class="loader" style="color: red;">Lỗi: ${err.message}</div>`;
                }
            });

            // 6. Tải danh sách ngân hàng ngay khi trang mở
            loadBanks();
        });
    </script>

</body>
</html>