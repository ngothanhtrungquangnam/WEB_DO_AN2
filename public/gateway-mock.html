<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n VietQR T·ª± ƒë·ªông</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: #333; }
        .gateway-container { width: 100%; max-width: 450px; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; text-align: center; position: relative; }
        .header { background: #008fe5; color: white; padding: 16px; font-weight: 600; font-size: 1.1rem; }
        .order-summary { padding: 20px; border-bottom: 1px dashed #eee; background: #fdfdfd; }
        .amount { font-size: 2rem; font-weight: 700; color: #008fe5; }
        .qr-frame { display: inline-block; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; margin: 20px 0; }
        .qr-frame img { width: 100%; max-width: 240px; display: block; }
        
        /* Loading Spinner */
        .processing-box { margin-bottom: 20px; color: #666; font-size: 0.9rem; }
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,143,229,0.3); border-radius: 50%; border-top-color: #008fe5; animation: spin 1s infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Success Screen */
        .success-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.5s ease; z-index: 10; }
        .success-overlay.active { opacity: 1; visibility: visible; }
        .checkmark-circle { width: 60px; height: 60px; background: #4CAF50; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .checkmark { color: white; font-size: 30px; }
        .success-text { color: #4CAF50; font-size: 1.2rem; font-weight: 700; }
    </style>
</head>
<body>

    <div class="gateway-container">
        <div class="success-overlay" id="successOverlay">
            <div class="checkmark-circle"><div class="checkmark">‚úì</div></div>
            <div class="success-text">Thanh to√°n th√†nh c√¥ng!</div>
            <p>ƒêang chuy·ªÉn h∆∞·ªõng...</p>
        </div>

        <div class="header">C·ªïng thanh to√°n</div>
        
        <div class="order-summary">
            <div>S·ªë ti·ªÅn c·∫ßn thanh to√°n</div>
            <div class="amount" id="amountDisplay">...</div>
            <div id="orderIdDisplay">...</div>
        </div>

        <div class="qr-frame">
            <img id="qrImage" src="" alt="ƒêang t·∫°o m√£ QR...">
        </div>

        <div class="processing-box">
            <div class="spinner"></div>
            ƒêang ch·ªù ng√¢n h√†ng x√°c nh·∫≠n...
        </div>
        
        <p style="font-size: 0.8rem; color: #999; padding-bottom: 20px;">
            H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t ngay khi ti·ªÅn v√†o t√†i kho·∫£n.
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- 1. L·∫§Y TH√îNG TIN T·ª™ URL ---
            const amountDisplay = document.getElementById('amountDisplay');
            const orderIdDisplay = document.getElementById('orderIdDisplay');
            const qrImage = document.getElementById('qrImage');
            const successOverlay = document.getElementById('successOverlay');

            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId'); 
            const amount = parseFloat(urlParams.get('amount')) || 10000;
            
            if (!orderId) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng!");
                return;
            }

            // Hi·ªÉn th·ªã th√¥ng tin c∆° b·∫£n
            amountDisplay.textContent = amount.toLocaleString('vi-VN') + ' VND';
            orderIdDisplay.textContent = `M√£ ƒë∆°n h√†ng: ${orderId}`;

            // --- 2. G·ªåI SERVER ƒê·ªÇ L·∫§Y NG√ÇN H√ÄNG (MB hay BIDV) ---
            // Thay v√¨ hardcode MY_BANK, ta g·ªçi API n√†y ƒë·ªÉ l·∫•y c·∫•u h√¨nh m·ªõi nh·∫•t
            try {
                const bankRes = await fetch('/api/payment/current-bank');
                const bankData = await bankRes.json();

                if (bankData.success && bankData.bankInfo) {
                    const bank = bankData.bankInfo;
                    
                    // T·∫°o link VietQR ƒë·ªông theo ng√¢n h√†ng Server tr·∫£ v·ªÅ
                    // C√∫ ph√°p chu·∫©n VietQR: https://img.vietqr.io/image/<BANK_ID>-<ACCOUNT_NO>-<TEMPLATE>.png
                    const qrUrl = `https://img.vietqr.io/image/${bank.BANK_ID}-${bank.ACCOUNT_NO}-${bank.TEMPLATE}.png?amount=${amount}&addInfo=${encodeURIComponent(orderId)}&accountName=${encodeURIComponent(bank.ACCOUNT_NAME)}`;
                    
                    // G√°n v√†o ·∫£nh
                    qrImage.src = qrUrl;
                    console.log("‚úÖ ƒêang hi·ªÉn th·ªã QR c·ªßa:", bank.BANK_ID);
                } else {
                    // Fallback n·∫øu l·ªói API (Gi·ªØ l·∫°i logic c≈© l√†m backup ƒë·ªÉ kh√¥ng b·ªã tr·∫Øng trang)
                    console.warn("‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin ng√¢n h√†ng, d√πng m·∫∑c ƒë·ªãnh MB.");
                    const content = orderId; 
                    qrImage.src = `https://img.vietqr.io/image/MB-0777488240-compact.png?amount=${amount}&addInfo=${encodeURIComponent(content)}`;
                }
            } catch (e) {
                console.error("‚ùå L·ªói l·∫•y bank:", e);
                qrImage.alt = "L·ªói t·∫£i m√£ QR. Vui l√≤ng th·ª≠ l·∫°i.";
            }

            // --- 3. LOGIC T·ª∞ ƒê·ªòNG CHECK TI·ªÄN (GI·ªÆ NGUY√äN 100%) ---
            let isSuccess = false;

            async function checkPaid() {
                if (isSuccess) return;

                try {
                    // console.log(`Checking order: ${orderId}...`);
                    
                    // Th√™m ?t=... ƒë·ªÉ tr√°nh tr√¨nh duy·ªát l∆∞u Cache c≈©
                    const response = await fetch(`/api/donhang/details/${orderId}?t=${new Date().getTime()}`);
                    
                    if (!response.ok) return;

                    const data = await response.json();
                    
                    // L·∫•y th√¥ng tin ti·ªÅn nong
                    const daTra = data.amountPaid || 0;
                    const tongTien = data.totalPrice || data.totalAmount || 0;

                    // ƒêi·ªÅu ki·ªán th√†nh c√¥ng
                    if (
                        data.trangThaiThanhToan === 'ƒê√£ thanh to√°n' || 
                        data.paymentStatus === 'paid' ||
                        (daTra > 0 && daTra >= tongTien)
                    ) {
                        isSuccess = true;
                        
                        // 1. Hi·ªán m√†n h√¨nh th√†nh c√¥ng (Overlay xanh l√°)
                        successOverlay.classList.add('active');
                        
                        // 2. Chuy·ªÉn h∆∞·ªõng sau 2 gi√¢y (Logic c≈© gi·ªØ nguy√™n)
                      setTimeout(() => {
                            // üëá S·ª¨A TH√ÄNH D√íNG N√ÄY ƒê·ªÇ LU√îN V·ªÄ TI·∫æN TR√åNH ƒê∆†N üëá
                            window.location.href = `/order-progress.html?newOrder=${orderId}`; 
                        }, 2000);
                    }
                } catch (error) {
                    console.error("L·ªói ki·ªÉm tra:", error);
                }
            }

            // G·ªçi h√†m checkPaid m·ªói 2 gi√¢y
            setInterval(checkPaid, 2000);
        });
    </script>
</body>
</html>