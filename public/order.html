<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gi·ªè H√†ng - Qu·∫£n L√Ω Qu√°n ƒÇn</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* ƒê·∫©y n·ªôi dung l√™n ƒë·ªÉ kh√¥ng b·ªã thanh menu d∆∞·ªõi che m·∫•t */
        body { padding-bottom: 90px; }

        .cart-summary .cart-input { box-sizing: border-box; width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.95rem; font-family: inherit; }
        textarea.cart-input { min-height: 60px; resize: vertical; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; border-radius: 10px; padding: 1.5rem 2rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-close { position: absolute; top: 8px; right: 15px; font-size: 2.2rem; font-weight: bold; cursor: pointer; color: #888; line-height: 1; }
        .modal-content h2 { text-align: center; color: #ff7043; margin-bottom: 1rem; }
        .legend { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #ccc; }
        .legend-trong { background-color: #e8f5e9; border-color: #4caf50; }
        .legend-daphucvu { background-color: #fff3e0; border-color: #ff9800; }
        .table-map { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; margin-top: 1rem; max-height: 60vh; overflow-y: auto; padding: 5px; }
        .table-item { border: 2px solid; border-radius: 8px; padding: 1.5rem 0.5rem; text-align: center; font-weight: bold; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .table-item.status-trong { border-color: #66bb6a; color: #388e3c; background: #e8f5e9; }
        .table-item.status-trong:hover { background: #c8e6c9; transform: scale(1.05); }
        .table-item.status-dang-phuc-vu { border-color: #ffa726; color: #f57c00; background: #fff3e0; cursor: not-allowed; opacity: 0.7; }
        .guest-count { position: absolute; top: 5px; right: 5px; background-color: rgba(0, 0, 0, 0.6); color: white; font-size: 0.75rem; padding: 2px 5px; border-radius: 50%; min-width: 18px; height: 18px; display: flex; justify-content: center; align-items: center; }
        .table-selector { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .table-selector input { flex-grow: 1; }
        .btn-chon-ban { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; transition: background-color 0.2s ease; }
        .btn-chon-ban:hover { background-color: #0056b3; }

        .payment-method-section { margin-top: 15px; margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .modal-content .payment-method-section { border-top: none; padding-top: 0; }
        .payment-method-option { display: flex; align-items: center; gap: 12px; border: 1px solid #ddd; padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.15s; user-select: none; }
        .payment-method-option:hover { background-color: #f9f9f9; }
        .payment-method-option input[type="radio"] { margin: 0; transform: scale(1.2); position: relative; z-index: 5; cursor: pointer; }
        .payment-method-option div { width: 100%; cursor: pointer; }
        #paymentModal .modal-content { z-index: 1010; position: relative; }
        footer { text-align: center; padding: 20px; margin-top: 20px; background-color: #f4f4f4; }
    </style>
    <style>
   /* --- CSS CHO MENU TR∆Ø·ª¢T T·ª™ D∆Ø·ªöI L√äN (BOTTOM SHEET) --- */

/* 1. L·ªõp n·ªÅn t·ªëi m·ªù (Overlay) */
.utility-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.5); /* M√†u ƒëen m·ªù 50% */
    z-index: 9998; /* N·∫±m d∆∞·ªõi menu nh∆∞ng tr√™n c√°c c√°i kh√°c */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    backdrop-filter: blur(2px); /* L√†m m·ªù nh·∫π h·∫≠u c·∫£nh cho ƒë·∫πp */
}
.utility-overlay.show {
    opacity: 1;
    visibility: visible;
}

/* 2. B·∫£n th√¢n c√°i Menu (Sheet) */
.utility-bottom-sheet {
    position: fixed;
    bottom: -100%; /* M·∫∑c ƒë·ªãnh gi·∫•u xu·ªëng d∆∞·ªõi ƒë√°y */
    left: 0;
    width: 100%;
    background: white;
    border-radius: 20px 20px 0 0; /* Bo tr√≤n 2 g√≥c tr√™n */
    z-index: 9999;
    padding-bottom: 20px; /* Ch·ª´a ch·ªó ·ªü d∆∞·ªõi cho ƒë·∫πp */
    box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
    transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Hi·ªáu ·ª©ng tr∆∞·ª£t m∆∞·ª£t */
}
.utility-bottom-sheet.show {
    bottom: 0; /* Tr∆∞·ª£t l√™n v·ªã tr√≠ 0 */
}

/* 3. Thanh g·∫°ch ngang nh·ªè (Handle) ƒë·ªÉ trang tr√≠ */
.sheet-handle {
    width: 40px;
    height: 4px;
    background-color: #e0e0e0;
    border-radius: 2px;
    margin: 12px auto; /* CƒÉn gi·ªØa */
}

/* 4. Ti√™u ƒë·ªÅ menu */
.utility-title {
    text-align: center;
    font-weight: 700;
    font-size: 16px;
    color: #333;
    padding: 5px 0 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

/* 5. C√°c n√∫t b·∫•m (Item) */
.utility-item {
    display: flex;
    align-items: center;
    padding: 16px 24px; /* N√∫t to, d·ªÖ b·∫•m */
    text-decoration: none;
    color: #333;
    font-size: 16px;
    font-weight: 500;
    transition: background 0.2s;
}
.utility-item:active {
    background-color: #f5f5f5; /* Hi·ªáu ·ª©ng khi b·∫•m v√†o */
}
.utility-item i {
    font-size: 1.4rem;
    margin-right: 16px;
    color: #ff6b6b;
    width: 25px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông icon ƒë·ªÉ ch·ªØ th·∫≥ng h√†ng */
    text-align: center;
}

/* 6. N√∫t ƒë√≥ng (Option th√™m) */
.close-sheet-btn {
    margin: 10px 20px 0;
    padding: 12px;
    text-align: center;
    background: #f1f1f1;
    border-radius: 12px;
    color: #666;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <main class="order-page-container">
        <div class="cart-wrapper">
            <section class="cart-section">
                <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>
                <div id="cartContainer" class="cart-items"></div>
                <div class="cart-summary">
                    <p id="cartTotal">T·ªïng c·ªông: 0 VND</p>

                    <input type="text" id="customerNameInput" class="cart-input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng..." required>

                    <div class="table-selector">
                        <input type="text" id="selectedTableDisplay" class="cart-input" placeholder="Ch∆∞a ch·ªçn b√†n" readonly style="cursor: pointer; background-color: #e9ecef;">
                        <button type="button" id="btnChonBan" class="btn-chon-ban">Ch·ªçn b√†n</button>
                    </div>
                    <small id="banError" style="color: red; display: none; text-align: left; margin-bottom: 10px;">Vui l√≤ng ch·ªçn b√†n.</small>

                    <textarea id="notesInput" class="cart-input" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>

                    <div class="table-selector">
                         <input type="text" id="selectedPaymentDisplay" class="cart-input" placeholder="Ch∆∞a ch·ªçn ph∆∞∆°ng th·ª©c" readonly
                            style="cursor: pointer; background-color: #e9ecef;"
                            value="Thanh to√°n t·∫°i qu·∫ßy">
                         <button type="button" id="btnChonThanhToan" class="btn-chon-ban">Ch·ªçn</button>
                    </div>
                    <small id="paymentError" style="color: red; display: none; text-align: left; margin-bottom: 10px;">Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.</small>
                    <button id="btnOrder" class="btn-order" style="margin-top: 10px;">G·ª≠i ƒë∆°n h√†ng</button>
                </div>
            </section>
        </div>
    </main>

    <div id="tableModal" class="modal-overlay">
        <div class="modal-content">
            <span id="closeModal" class="modal-close">&times;</span>
            <h2>Ch·ªçn b√†n</h2>
            <div class="legend">
                <div class="legend-item"><div class="legend-color legend-trong"></div><span>Tr·ªëng</span></div>
                <div class="legend-item"><div class="legend-color legend-daphucvu"></div><span>ƒêang ph·ª•c v·ª•</span></div>
            </div>
            <div id="tableMapContainer" class="table-map">
                <p>ƒêang t·∫£i s∆° ƒë·ªì b√†n...</p>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span id="closePaymentModal" class="modal-close">&times;</span>
            <h2>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h2>
            <div class="payment-method-section">
                <label class="payment-method-option" for="pay-cod" id="label-cod">
                    <input type="radio" id="pay-cod" name="paymentMethodModal" value="cod" checked>
                    <div style="flex:1;">
                        <strong>Thanh to√°n t·∫°i qu·∫ßy</strong>
                        <small>G·ª≠i ƒë∆°n cho b·∫øp v√† thanh to√°n sau</small>
                    </div>
                </label>
                <label class="payment-method-option" for="pay-zalopay" id="label-zalopay" style="margin-top: 15px;">
                    <input type="radio" id="pay-zalopay" name="paymentMethodModal" value="zalopay">
                    <div style="flex:1;">
                        <strong>Thanh to√°n Online ngay (ZaloPay)</strong>
                        <small>Thanh to√°n ngay b·∫±ng ZaloPay</small>
                    </div>
                </label>
            </div>
        </div>
    </div>

    <footer>
        <p>¬© 2025 Qu√°n ƒÇn Ngon 24h</p>
    </footer>

  <div id="utility-overlay" class="utility-overlay" onclick="closeUtilityMenu()"></div>
<div id="utility-overlay" class="utility-overlay" onclick="closeUtilityMenu()"></div>

<div id="utility-menu" class="utility-bottom-sheet">
    <div class="sheet-handle"></div>
    
    <div class="utility-title">Ti·ªán √≠ch m·ªü r·ªông</div>
    
    <a href="order-progress.html" class="utility-item">
        <i class="bi bi-hourglass-split"></i> 
        <span>Ti·∫øn tr√¨nh ƒë∆°n h√†ng</span>
    </a>
    
    <a href="order-history.html" class="utility-item">
        <i class="bi bi-clock-history"></i> 
        <span>L·ªãch s·ª≠ ƒë·∫∑t m√≥n</span>
    </a>

    <div class="close-sheet-btn" onclick="closeUtilityMenu()">ƒê√≥ng</div>
</div>
<div id="bottom-nav-placeholder"></div>

<script>
    function toggleUtilityMenu() {
        const menu = document.getElementById('utility-menu');
        if (!menu) return;
        menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        if (menu.style.display === 'flex') menu.classList.add('show');
    }
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('utility-menu');
        const btn = document.getElementById('nav-utility');
        if (menu && menu.style.display === 'flex' && !menu.contains(event.target) && (btn && !btn.contains(event.target))) {
            menu.style.display = 'none';
        }
    });
</script>

    <script src="script.js" defer></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/chatbox.js"></script>

    <script>
        // === BI·∫æN GLOBAL ===
        let selectedBanId = null;
        let userInfo = null;
        let selectedPaymentMethod = 'cod'; // m·∫∑c ƒë·ªãnh cod

        // === H·ªñ TR·ª¢ L·∫§Y userId AN TO√ÄN ===
        function getStoredUserId() {
            if (!userInfo) return null;
            return userInfo.userId || userInfo.id || userInfo._id || null;
        }

        // === C√ÅC H√ÄM C≈® ===
        function removeCartItem(index) {
            let cart = JSON.parse(localStorage.getItem("clientCart")) || [];
            cart.splice(index, 1);
            localStorage.setItem("clientCart", JSON.stringify(cart));
            location.reload();
        }
        function showToast(message) {
            if (typeof globalShowToast === 'function') {
                globalShowToast(message);
            } else {
                alert(message);
            }
        }
        function openTableModal() {
            document.getElementById('tableModal').style.display = 'flex';
            loadTableMap();
        }
        function closeTableModal() {
            document.getElementById('tableModal').style.display = 'none';
        }
        
        // --- H√ÄM LOAD TABLE MAP (GI·ªÆ NGUY√äN) ---
        async function loadTableMap() {
            const mapContainer = document.getElementById('tableMapContainer');
            mapContainer.innerHTML = '<p>ƒêang t·∫£i s∆° ƒë·ªì b√†n...</p>';
            try {
                const response = await fetch('/api/ban');
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i s∆° ƒë·ªì b√†n');
                let banList = await response.json(); // L·∫•y d·ªØ li·ªáu

                // S·∫Øp x·∫øp theo s·ªë
                banList.sort((a, b) => {
                    const numA = parseInt(a.soBan.match(/\d+/)?.[0] || 0);
                    const numB = parseInt(b.soBan.match(/\d+/)?.[0] || 0);
                    return numA - numB; 
                });

                mapContainer.innerHTML = ''; // X√≥a ch·ªØ "ƒêang t·∫£i"
                
                banList.forEach(ban => {
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'table-item';
                    tableDiv.id = `ban-${ban._id}`;
                    tableDiv.dataset.id = ban._id;
                    tableDiv.textContent = ban.soBan;
                    
                    if (ban.trangThai === 'Tr·ªëng') {
                        tableDiv.classList.add('status-trong');
                        tableDiv.addEventListener('click', () => selectBan(ban._id, ban.soBan));
                    } else {
                        tableDiv.classList.add('status-dang-phuc-vu');
                    }
                    // Th√™m s·ªë kh√°ch
                    if (ban.soKhach > 0) {
                        const guestSpan = document.createElement('span');
                        guestSpan.className = 'guest-count';
                        guestSpan.textContent = ban.soKhach;
                        tableDiv.appendChild(guestSpan);
                    }
                    
                    mapContainer.appendChild(tableDiv);
                });
            } catch (err) {
                console.error(err);
                mapContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
            }
        }

        function selectBan(banId, soBan) {
            selectedBanId = banId;
            document.getElementById('selectedTableDisplay').value = soBan;
            document.getElementById('banError').style.display = 'none';
            closeTableModal();
        }

        // === Modal thanh to√°n ===
        function openPaymentModal() {
            document.getElementById('paymentModal').style.display = 'flex';
        }
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }
        function selectPayment(method, text) {
            selectedPaymentMethod = method;
            document.getElementById('selectedPaymentDisplay').value = text;
            document.getElementById('paymentError').style.display = 'none';

            // c·∫≠p nh·∫≠t radio checked
            const radioCod = document.getElementById('pay-cod');
            const radioZalo = document.getElementById('pay-zalopay');
            if (radioCod) radioCod.checked = (method === 'cod');
            if (radioZalo) radioZalo.checked = (method === 'zalopay');

            closePaymentModal();
        }

        // ==========================================================
        // üî• H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN THANH TO√ÅN (GI·ªÆ NGUY√äN) üî•
        // ==========================================================
        function addPaymentModalListeners() {
            const btnChonThanhToan = document.getElementById('btnChonThanhToan');
            const paymentModal = document.getElementById('paymentModal');
            const closePaymentModalBtn = document.getElementById('closePaymentModal');
            const selectedPaymentInput = document.getElementById('selectedPaymentDisplay');

            // 1. G·∫Øn s·ª± ki·ªán m·ªü/ƒë√≥ng modal
            if(btnChonThanhToan) btnChonThanhToan.addEventListener('click', openPaymentModal);
            if(selectedPaymentInput) selectedPaymentInput.addEventListener('click', openPaymentModal);
            if(closePaymentModalBtn) closePaymentModalBtn.addEventListener('click', closePaymentModal);
            if(paymentModal) paymentModal.addEventListener('click', (e) => { if (e.target === paymentModal) closePaymentModal(); });

            const labelCod = document.getElementById('label-cod');
            const labelZalo = document.getElementById('label-zalopay');
            const inputCod = document.getElementById('pay-cod');
            const inputZalo = document.getElementById('pay-zalopay');

            // 2. H√†m x·ª≠ l√Ω logic khi ch·ªçn ph∆∞∆°ng th·ª©c
            function handlePaymentSelection(method, text) {
                selectedPaymentMethod = method;
                
                const displayInput = document.getElementById('selectedPaymentDisplay');
                if(displayInput) displayInput.value = text;
                
                const errorMsg = document.getElementById('paymentError');
                if(errorMsg) errorMsg.style.display = 'none';

                if (method === 'cod' && inputCod) inputCod.checked = true;
                if (method === 'zalopay' && inputZalo) inputZalo.checked = true;

                setTimeout(() => closePaymentModal(), 200); 
            }

            // 3. G·∫Øn s·ª± ki·ªán Click cho v√πng ch·ªçn (Label)
            if (labelCod) {
                labelCod.addEventListener('click', () => {
                    setTimeout(() => handlePaymentSelection('cod', 'Thanh to√°n t·∫°i qu·∫ßy'), 10);
                });
            }
            if (labelZalo) {
                labelZalo.addEventListener('click', () => {
                    setTimeout(() => handlePaymentSelection('zalopay', 'Thanh to√°n Online (ZaloPay)'), 10);
                });
            }

            // 4. G·∫Øn s·ª± ki·ªán Change cho n√∫t Radio
            if (inputCod) {
                inputCod.addEventListener('change', () => { 
                    if (inputCod.checked) handlePaymentSelection('cod', 'Thanh to√°n t·∫°i qu·∫ßy'); 
                });
            }
            if (inputZalo) {
                inputZalo.addEventListener('change', () => { 
                    if (inputZalo.checked) handlePaymentSelection('zalopay', 'Thanh to√°n Online (ZaloPay)'); 
                });
            }
            
            // 5. K√≠ch ho·∫°t tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
            if (inputCod && inputCod.checked) {
                handlePaymentSelection('cod', 'Thanh to√°n t·∫°i qu·∫ßy');
            }
        }

        // === H√†m ch√≠nh ===
        function runPageLogic() {
            const cartContainer = document.getElementById("cartContainer");
            const cartTotal = document.getElementById("cartTotal");
            const btnOrder = document.getElementById("btnOrder");
            const btnChonBan = document.getElementById('btnChonBan');
            const closeModalBtn = document.getElementById('closeModal');
            const modalOverlay = document.getElementById('tableModal');
            const selectedTableInput = document.getElementById('selectedTableDisplay');

            const authButton = document.getElementById("authButton");
            const utilityDropdown = document.getElementById("utilityDropdown");
            const navOrderLink = document.getElementById("nav-order-link");
            const navAdminLink = document.getElementById("nav-admin-link");

            addPaymentModalListeners();

            if(btnChonBan) btnChonBan.addEventListener('click', openTableModal);
            if(selectedTableInput) selectedTableInput.addEventListener('click', openTableModal);
            if(closeModalBtn) closeModalBtn.addEventListener('click', closeTableModal);
            if(modalOverlay) modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeTableModal(); });

            const cart = JSON.parse(localStorage.getItem("clientCart")) || [];

            // x·ª≠ l√Ω menu
            if (authButton && navOrderLink && navAdminLink) {
                if (userInfo) {
                    authButton.textContent = "ƒêƒÉng xu·∫•t";
                    if (utilityDropdown) utilityDropdown.style.display = "inline-block";
                    if (userInfo.role === "admin") {
                        navOrderLink.style.display = "none";
                        navAdminLink.style.display = "inline-block";
                    } else {
                        navOrderLink.style.display = "inline-block";
                        navAdminLink.style.display = "none";
                    }
                    authButton.addEventListener("click", () => { localStorage.clear(); window.location.href = "index.html"; });
                } else {
                    authButton.textContent = "ƒêƒÉng nh·∫≠p";
                    if (utilityDropdown) utilityDropdown.style.display = "none";
                    navOrderLink.style.display = "none";
                    navAdminLink.style.display = "none";
                    authButton.addEventListener("click", () => { window.location.href = "login.html"; });
                }
            }

            // hi·ªÉn th·ªã gi·ªè
            let total = 0;
            if (cart.length === 0) {
                cartContainer.innerHTML = "<p>üõçÔ∏è Gi·ªè h√†ng tr·ªëng!</p>";
                cartTotal.textContent = "T·ªïng c·ªông: 0 VND";
                if (btnOrder) btnOrder.disabled = true;
            } else {
                cartContainer.innerHTML = "";
                cart.forEach((item, index) => {
                    const itemPrice = item.gia || item.price || 0;
                    const itemTotal = itemPrice * item.quantity;
                    total += itemTotal;
                    const div = document.createElement("div");
                    div.className = "cart-item";
                    div.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="cart-img">
                        <div class="cart-info"><h3>${item.name}</h3><p>${itemPrice.toLocaleString("vi-VN")}ƒë x ${item.quantity}</p></div>
                        <div class="cart-actions"><span>${itemTotal.toLocaleString("vi-VN")}ƒë</span><button class="btn-remove" onclick="removeCartItem(${index})">X√≥a</button></div>
                    `;
                    cartContainer.appendChild(div);
                });
                cartTotal.textContent = `T·ªïng c·ªông: ${total.toLocaleString("vi-VN")} VND`;
            }

            // n√∫t g·ª≠i ƒë∆°n
            if (btnOrder) {
                btnOrder.addEventListener("click", async () => {
                    if (!userInfo || !userInfo.token) { showToast('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i ƒë∆°n h√†ng!'); return; }
                    if (cart.length === 0) { showToast('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!'); return; }

                    const customerName = document.getElementById("customerNameInput").value;
                    const notes = document.getElementById("notesInput").value;
                    const banId = selectedBanId;
                    const banError = document.getElementById('banError');
                    const paymentError = document.getElementById('paymentError');

                    const paymentMethod = selectedPaymentMethod;

                    let isValid = true;
                    if (!customerName) { showToast('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!'); isValid = false; }
                    if (!banId) { showToast('Vui l√≤ng ch·ªçn b√†n!'); if(banError) banError.style.display = 'block'; isValid = false; }
                    else { if(banError) banError.style.display = 'none'; }
                    if (!paymentMethod) { showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!'); if(paymentError) paymentError.style.display = 'block'; isValid = false; }
                    else { if(paymentError) paymentError.style.display = 'none'; }
                    if(!isValid) return;

                    const orderItems = cart.map(item => ({ itemId: item.id || item._id, quantity: item.quantity }));
                    const orderData = {
                        userId: getStoredUserId(),
                        customerName,
                        notes,
                        banId,
                        items: orderItems,
                        paymentMethod: paymentMethod,
                        totalPrice: total
                    };

                    try {
                        btnOrder.disabled = true; btnOrder.textContent = "ƒêang g·ª≠i...";

                        // 1) T·∫°o DonHang
                        const apiEndpoint = window.location.origin + '/api/donhang/create';
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json', 
                                'Authorization': `Bearer ${userInfo.token}` 
                            },
                            body: JSON.stringify(orderData) 
                        });

                        const createOrderResult = await response.json();

                        if (!response.ok) {
                            throw new Error(createOrderResult.message || 'L·ªói khi t·∫°o ƒë∆°n h√†ng');
                        }

                        // N·∫øu l√† COD -> nh∆∞ c≈©
                        if (paymentMethod === 'cod') {
                            showToast("‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!");
                            localStorage.removeItem("clientCart");
                            window.location.href = `/order-progress.html?newOrder=${createOrderResult.donHang._id}`;
                            return;
                        }

                        // N·∫øu l√† ZaloPay -> g·ªçi API t·∫°o link
                        if (paymentMethod === 'zalopay') {
                            const payResp = await fetch(window.location.origin + '/api/payment/zalopay/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userInfo.token}`
                                },
                                body: JSON.stringify({ orderId: createOrderResult.donHang._id, amount: createOrderResult.donHang.totalPrice })
                            });

                            const payJson = await payResp.json();
                            if (!payResp.ok) {
                                throw new Error(payJson.message || payJson.error || 'L·ªói t·∫°o link thanh to√°n');
                            }

                            if (payJson.paymentUrl) {
                                showToast('ƒêi t·ªõi c·ªïng thanh to√°n ZaloPay...');
                                localStorage.removeItem("clientCart");
                                window.location.href = payJson.paymentUrl;
                                return;
                            } else {
                                throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c paymentUrl t·ª´ server');
                            }
                        }

                    } catch (err) {
                        console.error('L·ªói khi g·ª≠i ƒë∆°n h√†ng:', err);
                        showToast(err.message || 'L·ªói k·∫øt n·ªëi ƒë·∫øn server!');
                    } finally {
                        btnOrder.disabled = false; btnOrder.textContent = "G·ª≠i ƒë∆°n h√†ng";
                    }
                });
            }
        }

        // === INIT ===
        document.addEventListener('DOMContentLoaded', () => {
            userInfo = JSON.parse(localStorage.getItem("userInfo"));
            let navbarFile = 'user-navbar.html';
            if (userInfo && userInfo.role === 'admin') {
                navbarFile = '/admin-navbar.html';
            }

            fetch(navbarFile)
                .then(response => {
                    if (!response.ok) throw new Error(`Kh√¥ng t√¨m th·∫•y file ${navbarFile}`);
                    return response.text();
                })
                .then(data => {
                    const navbarPlaceholder = document.getElementById('navbar-placeholder');
                    if (navbarPlaceholder) {
                        navbarPlaceholder.innerHTML = data;
                    } else {
                        console.error("Kh√¥ng t√¨m th·∫•y th·∫ª #navbar-placeholder!");
                        return;
                    }

                    if (typeof runPageLogic === 'function') {
                        runPageLogic();
                    } else {
                        console.error("Kh√¥ng t√¨m th·∫•y h√†m runPageLogic()!");
                    }
                })
                .catch(error => {
                    console.error('L·ªói t·∫£i menu:', error);
                    const navbarPlaceholder = document.getElementById('navbar-placeholder');
                    if (navbarPlaceholder) {
                        navbarPlaceholder.innerHTML = `<p style="color:red; text-align:center;">L·ªñI T·∫¢I MENU (${error.message})</p>`;
                    }
                });
            
            // G·ªçi h√†m t·∫£i Bottom Navbar
            loadBottomNavbar();
        });

        // === üî• H√ÄM T·∫¢I BOTTOM NAVBAR (ƒê√É CH·ªàNH S·ª¨A CLASS) üî• ===
        async function loadBottomNavbar() {
            const placeholder = document.getElementById('bottom-nav-placeholder');
            if (!placeholder) return;

            try {
                // T·∫£i file bottom-nav.html
                const response = await fetch('bottom-nav.html');
                if (!response.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c navbar d∆∞·ªõi');
                const html = await response.text();
                placeholder.innerHTML = html;

                // Sau khi t·∫£i xong, c·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng gi·ªè h√†ng n·∫øu c·∫ßn
                if (typeof updateMobileCartCount === 'function') {
                    updateMobileCartCount();
                }

                const path = window.location.pathname;

                // üî• QUAN TR·ªåNG: T√¨m ƒë√∫ng class mobile-bottom-nav ƒë·ªÉ t√¥ m√†u
                const navItems = document.querySelectorAll('.mobile-bottom-nav .nav-item, .bottom-navbar .nav-item');
                navItems.forEach(el => el.classList.remove('active'));

                if (path.includes('order.html')) {
                    document.getElementById('nav-cart')?.classList.add('active');
                } else {
                    document.getElementById('nav-home')?.classList.add('active');
                }

            } catch (error) {
                console.error("L·ªói t·∫£i bottom navbar:", error);
            }
        }
    </script>
    <script src="js/script.js"></script>
</body>
</html>