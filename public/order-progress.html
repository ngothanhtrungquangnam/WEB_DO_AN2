    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ti·∫øn tr√¨nh ƒë∆°n h√†ng</title>
        <link rel="stylesheet" href="style.css"> 
        <script src="/socket.io/socket.io.js"></script>
        <style>
            /* --- CSS C≈® (GI·ªÆ NGUY√äN) --- */
            body { background-color: #f4f4f4; margin: 0; font-family: sans-serif; }
            .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
            h2 { text-align: center; color: #ff7043; margin-bottom: 2rem; }
            .order-card { background: #fff; margin-bottom: 1.5rem; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
            .order-header { padding: 1rem 1.5rem; background: #fffaf7; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
            .order-body { padding: 1.5rem; }
            .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; align-items: center;}
            .order-item:last-child { border-bottom: none; }
            .order-footer { padding: 1rem 1.5rem; background: #f9f9f9; text-align: right; font-size: 1.2rem; font-weight: bold; }
            
            /* Progress Bar */
            .progress-bar { display: flex; padding-top: 15px; margin-top: 15px; border-top: 1px dashed #eee; }
            .progress-step { flex: 1; text-align: center; position: relative; color: #aaa; font-size: 0.85rem; font-weight: 500; }
            .progress-step .dot { width: 14px; height: 14px; background-color: #ddd; border-radius: 50%; display: inline-block; border: 2px solid #f4f4f4; position: relative; z-index: 2; }
            .progress-step .step-label { margin-top: 5px; }
            .progress-step::after { content: ''; position: absolute; top: 8px; left: 50%; width: 100%; height: 3px; background-color: #ddd; z-index: 1; }
            .progress-step:last-child::after { display: none; }
            .progress-step.active { color: #007bff; font-weight: bold; }
            .progress-step.active .dot { background-color: #007bff; }
            .progress-step.active::after { background-color: #007bff; }
            .progress-step.completed { color: #4caf50; font-weight: bold; }
            .progress-step.completed .dot { background-color: #4caf50; }
            .progress-step.completed::after { background-color: #4caf50; }
            
            /* Status Text */
            .status-cancelled { color: #f44336; font-weight: bold; font-size: 1rem; text-align: center; padding: 15px 0; border-top: 1px dashed #eee; margin-top: 15px; }
            .payment-status { font-size: 0.9rem; text-align: right; padding-bottom: 10px; }
            .payment-status-paid { color: #28a745; font-weight: bold; }
            .payment-status-unpaid { color: #fd7e14; font-weight: bold; }
            .payment-status-pending { color: #007bff; font-weight: bold; }

            /* --- CSS M·ªöI: BUTTONS ITEM --- */
            .item-controls { display: inline-flex; align-items: center; gap: 5px; margin-left: 10px; }
            .btn-action { cursor: pointer; border: 1px solid #ddd; background: #fff; border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s; }
            .btn-action:hover { background-color: #f0f0f0; transform: scale(1.05); }
            .btn-inc { color: green; border-color: #c3e6cb; background-color: #f0fff4; }
            .btn-dec { color: orange; border-color: #ffeeba; background-color: #fff3cd; }
            .btn-del { color: red; border-color: #f5c6cb; background-color: #f8d7da; }

            /* --- CSS M·ªöI: BUTTON CHUY·ªÇN B√ÄN & G·ªåI TH√äM --- */
            .btn-switch-table {
                background-color: #ffc107; 
                border: 1px solid #e0a800;
                color: #333; 
                padding: 5px 10px; 
                border-radius: 4px; 
                font-size: 0.85rem; 
                cursor: pointer; 
                font-weight: bold;
                margin-left: 10px;
                display: inline-flex; align-items: center; gap: 5px;
            }
            .btn-switch-table:hover { background-color: #e0a800; }

            .btn-add-more {
                width: 100%;
                padding: 12px;
                background-color: #28a745;
                color: white;
                border: none;
                border-radius: 5px;
                font-weight: bold;
                font-size: 1rem;
                margin-top: 15px;
                cursor: pointer;
                display: flex; justify-content: center; align-items: center; gap: 8px;
                transition: background 0.2s;
            }
            .btn-add-more:hover { background-color: #218838; }

            /* --- CSS M·ªöI: MODAL MENU --- */
            .modal {
                display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
                position: fixed; 
                z-index: 1000; 
                left: 0; top: 0;
                width: 100%; height: 100%; 
                background-color: rgba(0,0,0,0.6); /* N·ªÅn ƒëen m·ªù */
                backdrop-filter: blur(2px);
            }
            .modal-content {
                background-color: white;
                margin: 5% auto;
                padding: 0;
                border-radius: 12px;
                width: 95%;
                max-width: 500px;
                max-height: 85vh; 
                overflow: hidden;
                display: flex; flex-direction: column;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                position: relative;
            }
            .modal-header {
                padding: 15px;
                border-bottom: 1px solid #eee;
                background: #fffaf7;
                display: flex; justify-content: space-between; align-items: center;
            }
            .modal-header h3 { margin: 0; color: #ff7043; }
            .close-modal {
                font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; line-height: 1;
            }
            .close-modal:hover { color: #333; }
            
            #menu-list-container {
                padding: 15px;
                overflow-y: auto;
            }
            
            .menu-item-row {
                display: flex; justify-content: space-between; align-items: center;
                padding: 12px 0; border-bottom: 1px solid #f0f0f0;
            }
            .menu-item-row:last-child { border-bottom: none; }
            .menu-item-row {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 12px 0; 
        border-bottom: 1px solid #f0f0f0;
    }

    /* --- CSS M·ªöI TH√äM CHO ·∫¢NH --- */
    /* Group bao quanh ·∫£nh v√† t√™n m√≥n ƒë·ªÉ n·∫±m v·ªÅ b√™n tr√°i */
    .menu-item-left-group {
        display: flex;
        align-items: center;
        flex: 1; /* Chi·∫øm ph·∫ßn kh√¥ng gian c√≤n l·∫°i */
    }

    /* Style cho ·∫£nh thumbnail */
    .menu-item-thumb {
        width: 60px;       /* Chi·ªÅu r·ªông ·∫£nh */
        height: 60px;      /* Chi·ªÅu cao ·∫£nh */
        object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng b·ªã m√©o n·∫øu t·ª∑ l·ªá kh√¥ng chu·∫©n */
        border-radius: 8px;/* Bo tr√≤n g√≥c nh·∫π */
        margin-right: 15px;/* Kho·∫£ng c√°ch gi·ªØa ·∫£nh v√† t√™n m√≥n */
        border: 1px solid #eee;
        background-color: #f9f9f9; /* M√†u n·ªÅn d·ª± ph√≤ng khi ·∫£nh ch∆∞a t·∫£i */
    }
            .btn-select-food {
                background: #007bff; color: white; border: none;
                padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            }
            .btn-select-food:hover { background: #0056b3; }


            /* --- CSS M·ªöI: MODAL QR CODE --- */
    #qrModal {
        display: none; 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); 
        z-index: 2000; /* Cao h∆°n c√°c modal kh√°c */
        justify-content: center; 
        align-items: center;
    }
    .qr-modal-content {
        background: white; 
        padding: 25px; 
        border-radius: 15px; 
        width: 90%; 
        max-width: 400px; 
        text-align: center; 
        position: relative;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        animation: zoomIn 0.3s;
    }
    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .qr-close-btn {
        position: absolute; 
        top: 10px; right: 15px; 
        font-size: 28px; 
        cursor: pointer; 
        font-weight: bold; 
        color: #888;
    }
    .qr-close-btn:hover { color: #333; }
    .btn-finish-transfer {
        width: 100%; 
        padding: 12px; 
        margin-top: 20px; 
        background: #28a745; 
        color: white; 
        border: none; 
        border-radius: 8px; 
        font-weight: bold; 
        cursor: pointer; 
        font-size: 1rem;
    }
    .btn-finish-transfer:hover { background: #218838; }
        </style>
    </head>
    <body>

        <div id="navbar-placeholder"></div>

        <main class="container">
            <h2>Ti·∫øn tr√¨nh ƒê∆°n h√†ng</h2>
            <div id="order-list-container">
                <p style="text-align: center;">ƒêang t·∫£i c√°c ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω...</p>
            </div>
        </main>

        <div id="menuModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üçΩÔ∏è Menu Qu√°n</h3>
                    <span class="close-modal" onclick="dongModalMenu()">&times;</span>
                </div>
                <div id="menu-loading" style="text-align: center; padding: 20px; display: none;">
                    ‚è≥ ƒêang t·∫£i menu...
                </div>
                <div id="menu-list-container">
                    </div>
            </div>
        </div>
      <div id="qrModal">
    <div class="qr-modal-content">
        <span class="qr-close-btn" ...>&times;</span>
        
        <h3 style="color:#0056b3; margin-top:0;">Qu√©t m√£ ƒë·ªÉ thanh to√°n</h3>
        
        <p id="bankNote" style="font-weight:bold; color:#d32f2f; margin: 10px 0; font-size: 1rem; background: #fff0f0; padding: 8px; border-radius: 5px; border: 1px dashed #ffcccc;">
            ƒêang t·∫£i th√¥ng tin ng√¢n h√†ng...
        </p>
        <p style="font-size:0.9rem; color:#555; margin-bottom: 15px;">S·ª≠ d·ª•ng App Ng√¢n h√†ng ho·∫∑c Camera ƒë·ªÉ qu√©t</p>
            
            <img id="vietqrImage" src="" alt="ƒêang t·∫°o m√£ QR..." style="width:100%; border-radius:10px; border: 1px solid #ddd; min-height: 300px; object-fit: contain;">
            
            <div style="margin-top:15px; background:#f9f9f9; padding:15px; border-radius:8px; text-align:left; font-size:0.95rem;">
                <div style="margin-bottom: 5px;">üí∞ S·ªë ti·ªÅn: <b id="qrAmount" style="color:red; font-size:1.2rem;">...</b></div>
                <div>üìù N·ªôi dung: <b id="qrContent" style="color:#333;">...</b></div>
            </div>

            <button class="btn-finish-transfer" onclick="document.getElementById('qrModal').style.display='none'">
                ƒê√£ chuy·ªÉn kho·∫£n xong
            </button>
        </div>
    </div>
        </div>
    </div>
        
        <footer>
            <p style="text-align: center; margin-top: 30px; color: #888;">¬© 2025 Qu√°n ƒÇn Ngon 24h</p>
        </footer>

        <script>
            let userInfo = null;
            let socket = null;
            let currentTargetOrderId = null; // Bi·∫øn l∆∞u ID ƒë∆°n h√†ng ƒëang thao t√°c g·ªçi th√™m
            let qrCheckInterval = null;

            // --- C√ÅC H√ÄM TI·ªÜN √çCH ---

            function renderProgressBar(status) {
                const steps = ['M·ªõi', 'ƒêang x·ª≠ l√Ω', 'Ho√†n th√†nh'];
                let currentStepIndex = steps.indexOf(status);
                if (status === 'ƒê√£ h·ªßy') {
                    return `<div class="status-cancelled">‚ùå ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy</div>`;
                }
                let html = '<div class="progress-bar">';
                for (let i = 0; i < steps.length; i++) {
                    let stepClass = 'progress-step';
                    if (i <= currentStepIndex) {
                        stepClass += (i === steps.length - 1) ? ' completed' : ' active';
                    }
                    html += `<div class="${stepClass}"><div class="dot"></div><div class="step-label">${steps[i]}</div></div>`;
                }
                html += '</div>';
                return html;
            }
            function closeQRModal() {
                document.getElementById('qrModal').style.display = 'none';
                // D·ª´ng vi·ªác ki·ªÉm tra ngay l·∫≠p t·ª©c
                if (qrCheckInterval) {
                    clearInterval(qrCheckInterval);
                    qrCheckInterval = null;
                }
            }

    function renderPaymentStatus(order) {
        // 1. L·∫•y th√¥ng tin ti·ªÅn
        const tongTien = order.totalPrice || order.totalAmount || 0;
        const daTra = order.amountPaid || 0; 
        const chenhLech = tongTien - daTra;

        // Style cho n√∫t b·∫•m QR (ch·ªâ d√πng cho chuy·ªÉn kho·∫£n)
        const btnStyle = "cursor:pointer; text-decoration:underline; color:#007bff; font-weight:bold; border:none; background:none; padding:0; font-size:0.95rem;";

        // ============================================================
        // TR∆Ø·ªúNG H·ª¢P 1: ƒê√£ thanh to√°n xong (Xanh l√°)
        // ============================================================
        if (order.trangThaiThanhToan === 'ƒê√£ thanh to√°n' || order.paymentStatus === 'paid' || (daTra > 0 && chenhLech <= 0)) {
            return `<span class="payment-status-paid">‚úÖ ƒê√£ thanh to√°n</span>`;
        }

        // ============================================================
        // TR∆Ø·ªúNG H·ª¢P 2: Thanh to√°n TI·ªÄN M·∫∂T (S·ª≠a theo √Ω b·∫°n)
        // => Ch·ªâ hi·ªán ch·ªØ, KH√îNG HI·ªÜN N√öT QR
        // ============================================================
        // Ki·ªÉm tra k·ªπ c√°c t·ª´ kh√≥a c√≥ th·ªÉ l∆∞u trong DB
        if (order.paymentMethod === 'Ti·ªÅn m·∫∑t' || order.paymentMethod === 'cash' || order.paymentMethod === 'cod') {
            
            // Tr·∫£ v·ªÅ HTML ch·ªâ c√≥ ch·ªØ, kh√¥ng c√≥ th·∫ª <button>
            return `<span class="payment-status-unpaid" style="color: #ff9800; font-weight: bold;">
                        üíµ Vui l√≤ng thanh to√°n t·∫°i qu·∫ßy (${formatCurrency(chenhLech)})
                    </span>`;
        }

        // ============================================================
        // TR∆Ø·ªúNG H·ª¢P 3: Chuy·ªÉn kho·∫£n / M·∫∑c ƒë·ªãnh (Hi·ªán n√∫t QR)
        // ============================================================
        
        // N·∫øu d∆∞ n·ª£ (C·∫ßn ho√†n l·∫°i)
        if (chenhLech < 0) {
            return `<span style="color: purple; font-weight: bold;">üü£ C·∫ßn ho√†n l·∫°i: ${formatCurrency(Math.abs(chenhLech))}</span>`;
        }

        // N·∫øu thi·∫øu ti·ªÅn -> Hi·ªán n√∫t QR
        if (chenhLech > 0) {
            // Ch∆∞a tr·∫£ ƒë·ªìng n√†o
            if (daTra === 0) {
                return `
                    <span class="payment-status-pending">‚è≥ Ch·ªù chuy·ªÉn kho·∫£n</span>
                    <button onclick="showTransferQR('${order._id}', ${chenhLech})" style="${btnStyle}; margin-left:8px;">
                        [üì≤ L·∫•y m√£ QR]
                    </button>
                `;
            } 
            // ƒê√£ tr·∫£ 1 ph·∫ßn, c√≤n thi·∫øu
            else {
                return `
                    <span style="color: #fd7e14; font-weight: bold;">‚ö†Ô∏è Thi·∫øu: ${formatCurrency(chenhLech)}</span>
                    <button onclick="showTransferQR('${order._id}', ${chenhLech})" style="${btnStyle}; margin-left:8px;">
                        [üì≤ QR Tr·∫£ n·ªët]
                    </button>
                `;
            }
        }

        return `<span class="payment-status-pending">‚è≥ ƒêang x·ª≠ l√Ω...</span>`;
    }
        function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }
            
            if (typeof globalShowToast !== 'function') {
                window.showToast = function(message) { alert(message); }
            }

            // --- 1. API: C·∫¨P NH·∫¨T M√ìN (TƒÉng/Gi·∫£m/X√≥a/Th√™m) ---
            async function goiApiCapNhatMon(orderId, itemId, quantity) {
                // quantity = 0: X√≥a
                // quantity > 0: C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                
                // Ch·ªâ hi·ªán confirm khi x√≥a h·∫≥n (quantity = 0) ƒë·ªÉ thao t√°c nhanh h∆°n
                if (quantity === 0 && !confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√≥n n√†y?")) return;
                
                try {
                    const response = await fetch('/api/donhang/update-item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId, itemId, quantity })
                    });
                    const data = await response.json();

                    if (data.success) {
                        if (quantity === 1 && currentTargetOrderId) {
                            // Tr∆∞·ªùng h·ª£p g·ªçi t·ª´ Modal (Th√™m m√≥n m·ªõi)
                            alert("‚úÖ ƒê√£ th√™m m√≥n v√†o ƒë∆°n!");
                            dongModalMenu();
                        }
                        loadActiveOrders(); // Reload l·∫°i giao di·ªán
                    } else {
                        alert(data.message); // B√°o l·ªói (VD: ƒê∆°n ƒë√£ kh√≥a)
                    }
                } catch (err) {
                    console.error(err);
                    alert("L·ªói k·∫øt n·ªëi server!");
                }
            }
    // --- H√ÄM M·ªöI: HI·ªÇN TH·ªä QR V√Ä T·ª∞ ƒê·ªòNG CHECK THANH TO√ÅN (ƒê√É S·ª¨A L·ªñI) ---
    async function showTransferQR(orderId, amountOverride = null) {
        try {
            // 1. Reset v√≤ng l·∫∑p c≈© (n·∫øu c√≥)
            if (typeof qrCheckInterval !== 'undefined' && qrCheckInterval) clearInterval(qrCheckInterval);

            // 2. Hi·ªÉn th·ªã modal loading (GI·ªÆ NGUY√äN)
            const modal = document.getElementById('qrModal');
            const img = document.getElementById('vietqrImage');
            const txtAmount = document.getElementById('qrAmount');
            const txtContent = document.getElementById('qrContent');
            const bankNote = document.getElementById('bankNote'); // (M·ªõi th√™m ƒë·ªÉ hi·ªán t√™n NH)
            
            if(modal) modal.style.display = 'flex';
            if(img) img.src = 'https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif'; // ·∫¢nh loading
            if(txtAmount) txtAmount.innerText = 'ƒêang t√≠nh...';
            if(txtContent) txtContent.innerText = '...';

            // 3. Chu·∫©n b·ªã d·ªØ li·ªáu (GI·ªÆ NGUY√äN)
            const payload = { orderId: orderId };
            if (amountOverride !== null && amountOverride > 0) {
                payload.amount = amountOverride;
            }

            // 4. G·ªçi API t·∫°o QR (S·ª¨A ƒê√öNG D√íNG N√ÄY)
            // G·ªçi v√†o route m·ªõi m√† ch√∫ng ta v·ª´a t·∫°o ·ªü b∆∞·ªõc tr∆∞·ªõc
            const res = await fetch('/api/payment/create-vietqr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json(); 

            if (data.success) {
                // C·∫≠p nh·∫≠t ·∫£nh QR (GI·ªÆ NGUY√äN)
                if(img) img.src = data.qrCodeUrl;
                if(txtAmount) txtAmount.innerText = parseInt(data.amount).toLocaleString('vi-VN') + 'ƒë';
                if(txtContent) txtContent.innerText = data.memo;
                
                // (M·ªõi th√™m) Hi·ªÉn th·ªã t√™n ng√¢n h√†ng ƒë·ªÉ kh√°ch bi·∫øt ƒëang chuy·ªÉn v√†o ƒë√¢u
                if(bankNote && data.bankInfo) {
                    bankNote.innerText = `Ng√¢n h√†ng: ${data.bankInfo.bankId} - STK: ${data.bankInfo.accountNo}`;
                }

                // =======================================================
                // üî• B·∫ÆT ƒê·∫¶U V√íNG L·∫∂P KI·ªÇM TRA (POLLING) - GI·ªÆ NGUY√äN üî•
                // =======================================================
                qrCheckInterval = setInterval(async () => {
                    try {
                        const checkRes = await fetch(`/api/donhang/details/${orderId}?t=${new Date().getTime()}`);
                        if (!checkRes.ok) return;

                        const orderInfo = await checkRes.json();
                        
                        console.log("üîç ƒêang ki·ªÉm tra...", orderInfo.trangThaiThanhToan);

                        const daTra = orderInfo.amountPaid || 0;
                        const tongTien = orderInfo.totalPrice || 0;

                        if (
                            orderInfo.trangThaiThanhToan === 'ƒê√£ thanh to√°n' || 
                            (daTra > 0 && daTra >= tongTien)
                        ) {
                            clearInterval(qrCheckInterval); // D·ª´ng ki·ªÉm tra
                            if(typeof closeQRModal === 'function') closeQRModal(); // T·∫Øt modal
                            if(typeof loadActiveOrders === 'function') loadActiveOrders(); // Load l·∫°i list
                            alert("‚úÖ Thanh to√°n th√†nh c√¥ng!");
                        }
                    } catch (e) {
                        console.error("L·ªói check status:", e);
                    }
                }, 2000); 

            } else {
                // üëá X·ª¨ L√ù RI√äNG TR∆Ø·ªúNG H·ª¢P ƒê√É THANH TO√ÅN ƒê·ª¶ üëá
                if (data.message === "ƒê∆°n h√†ng ƒë√£ thanh to√°n ƒë·ªß!") {
                    console.log("ƒê∆°n h√†ng ƒë√£ thanh to√°n xong, kh√¥ng c·∫ßn hi·ªán QR.");
                    if(typeof closeQRModal === 'function') closeQRModal();
                    if(typeof loadActiveOrders === 'function') loadActiveOrders(); // Load l·∫°i ƒë·ªÉ hi·ªán m√†u xanh
                    
                    // (T√πy ch·ªçn) Hi·ªán th√¥ng b√°o nh·∫π nh√†ng thay v√¨ Alert l·ªói
                    // alert("‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c thanh to√°n ho√†n t·∫•t!"); 
                } else {
                    // C√°c l·ªói kh√°c th√¨ v·∫´n hi·ªán Alert nh∆∞ th∆∞·ªùng
                    alert('L·ªói t·∫°o m√£ QR: ' + data.message);
                    if(typeof closeQRModal === 'function') closeQRModal();
                }
            }

        } catch (err) {
            console.error(err);
            alert('L·ªói k·∫øt n·ªëi server khi t·∫°o QR!');
            if(typeof closeQRModal === 'function') closeQRModal();
        }
    }
    // ƒê√≥ng modal khi click ra ngo√†i v√πng tr·∫Øng
            window.addEventListener('click', function(event) {
                const modalQR = document.getElementById('qrModal');
                const modalMenu = document.getElementById('menuModal');
                
                if (event.target == modalQR) {
                    closeQRModal(); // S·ª≠a th√†nh h√†m n√†y
                }
                if (event.target == modalMenu) {
                    dongModalMenu();
                }
            });

            // --- 2. API: CHUY·ªÇN B√ÄN ---
            async function goiApiChuyenBan(orderId, currentTableName) {
                // Trong th·ª±c t·∫ø, n√™n d√πng Modal Dropdown ch·ªçn b√†n. 
                // ·ªû ƒë√¢y d√πng prompt nh·∫≠p ID/T√™n b√†n ƒë·ªÉ gi·ªØ code ƒë∆°n gi·∫£n nh∆∞ y√™u c·∫ßu.
                const newTableId = prompt(`ƒê∆°n h√†ng ƒëang ·ªü ${currentTableName}.\nNh·∫≠p ID b√†n m·ªõi mu·ªën chuy·ªÉn sang (L·∫•y ID t·ª´ DB):`);
                
                if (!newTableId) return;

                try {
                    const response = await fetch('/api/donhang/switch-table', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId, newTableId })
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert("‚úÖ " + data.message);
                        loadActiveOrders();
                    } else {
                        alert(data.message);
                    }
                } catch (err) {
                    console.error(err);
                    alert("L·ªói k·∫øt n·ªëi server!");
                }
            }

            // --- 3. LOGIC MODAL MENU ---
            async function moModalGoiThem(orderId) {
                currentTargetOrderId = orderId; 
                document.getElementById('menuModal').style.display = 'block';
                document.getElementById('menu-loading').style.display = 'block';
                const container = document.getElementById('menu-list-container');
                container.innerHTML = ''; // Clear c≈©

                try {
                    // üî• G·ªåI API L·∫§Y MENU TO√ÄN B·ªò M√ìN
                    const res = await fetch('/api/monan'); 
                    
                    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i menu");
                    
                    const foods = await res.json();
                    document.getElementById('menu-loading').style.display = 'none';

                    if (foods.length === 0) {
                        container.innerHTML = '<p style="text-align:center">Menu tr·ªëng.</p>';
                        return;
                    }

                container.innerHTML = foods.map(food => `
        <div class="menu-item-row">
            <div class="menu-item-left-group">
                <img src="${food.image}" alt="${food.name}" class="menu-item-thumb" onerror="this.src='/images/default-food.png'">
                
                <div>
                    <strong>${food.name}</strong>
                    <div style="color: #666; font-size: 0.9rem;">${formatCurrency(food.price || food.gia)}</div>
                </div>
            </div>

            <button class="btn-select-food" onclick="chonMonTuMenu('${food._id}')">
                + Th√™m
            </button>
        </div>
    `).join('');
                } catch (e) {
                    console.error(e);
                    document.getElementById('menu-loading').style.display = 'none';
                    container.innerHTML = '<p style="text-align:center; color:red">L·ªói t·∫£i menu.</p>';
                }
            }

            function dongModalMenu() {
                document.getElementById('menuModal').style.display = 'none';
                currentTargetOrderId = null;
            }

    // --- S·ª¨A H√ÄM CH·ªåN M√ìN T·ª™ MENU (TH√îNG MINH H∆†N) ---
    async function chonMonTuMenu(foodId) {
        if (!currentTargetOrderId) return;

        // 1. Hi·ªÉn th·ªã th√¥ng b√°o nh·ªè ho·∫∑c hi·ªáu ·ª©ng (T√πy ch·ªçn)
        // console.log("ƒêang th√™m m√≥n:", foodId);

        try {
            // 2. L·∫•y th√¥ng tin ƒë∆°n h√†ng hi·ªán t·∫°i ƒë·ªÉ bi·∫øt m√≥n ƒë√≥ ƒë√£ c√≥ ch∆∞a
            // (Ph·∫£i g·ªçi API ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t, tr√°nh d√πng bi·∫øn c≈©)
            const res = await fetch(`/api/donhang/details/${currentTargetOrderId}?t=${new Date().getTime()}`);
            if (!res.ok) throw new Error("L·ªói l·∫•y chi ti·∫øt ƒë∆°n");
            
            const order = await res.json();
            
            // 3. T√¨m xem m√≥n ƒÉn n√†y ƒë√£ t·ªìn t·∫°i trong gi·ªè ch∆∞a
            // L∆∞u √Ω: itemId c√≥ th·ªÉ l√† Object (n·∫øu populate) ho·∫∑c String
            const itemExist = order.items.find(i => 
                (i.itemId._id && i.itemId._id.toString() === foodId) || // Tr∆∞·ªùng h·ª£p ƒë√£ populate
                (i.itemId.toString() === foodId)                        // Tr∆∞·ªùng h·ª£p ch∆∞a populate
            );

            let newQuantity = 1;

            if (itemExist) {
                // N·∫øu ƒë√£ c√≥ -> C·ªông d·ªìn s·ªë l∆∞·ª£ng c≈© + 1
                newQuantity = itemExist.quantity + 1;
                console.log(`M√≥n ƒë√£ c√≥ (SL: ${itemExist.quantity}). TƒÉng l√™n: ${newQuantity}`);
            } else {
                console.log("M√≥n m·ªõi. Th√™m v√†o SL: 1");
            }

            // 4. G·ªçi API c·∫≠p nh·∫≠t v·ªõi s·ªë l∆∞·ª£ng ƒê√É T√çNH TO√ÅN
            await goiApiCapNhatMon(currentTargetOrderId, foodId, newQuantity);
            
            // 5. Th√¥ng b√°o nh·∫π (T√πy ch·ªçn)
            // alert("‚úÖ ƒê√£ th√™m m√≥n v√†o ƒë∆°n!"); 

        } catch (e) {
            console.error("L·ªói khi ch·ªçn m√≥n:", e);
            alert("Kh√¥ng th·ªÉ th√™m m√≥n. Vui l√≤ng th·ª≠ l·∫°i!");
        }
    }

            // ƒê√≥ng modal khi click ra ngo√†i
            window.onclick = function(event) {
                const modal = document.getElementById('menuModal');
                if (event.target == modal) {
                    dongModalMenu();
                }
            }

            // --- 4. H√ÄM T·∫¢I & RENDER ƒê∆†N H√ÄNG ---
            async function loadActiveOrders() {
                const container = document.getElementById('order-list-container');
                
                const token = userInfo ? userInfo.token : null;
                if (!token) { 
                    container.innerHTML = '<p style="text-align: center; color: red;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem.</p>';
                    return; 
                }
                
                try {
                    const userId = userInfo ? (userInfo.userId || userInfo._id) : null;
                    if (!userId) throw new Error("Thi·∫øu userId.");

                    const response = await fetch(`/api/donhang/my-active?userId=${userId}`, { 
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || 'L·ªói t·∫£i ƒë∆°n h√†ng.');
                    }
                    
                    const allOrders = await response.json();
                    const activeOrders = allOrders.filter(order => order.status === 'M·ªõi' || order.status === 'ƒêang x·ª≠ l√Ω');
                    
                    if (!activeOrders || activeOrders.length === 0) {
                        container.innerHTML = '<p style="text-align: center;">B·∫°n kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.</p>';
                        return;
                    }
                    
                    container.innerHTML = ''; 
                    activeOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    // RENDER T·ª™NG ƒê∆†N H√ÄNG
                    activeOrders.forEach(order => {
                        const orderCard = document.createElement('div');
                        orderCard.className = 'order-card'; 
                        orderCard.id = `order-card-${order._id}`; 
                        
                        const paymentStatusHtml = renderPaymentStatus(order);
                        const progressBarHtml = renderProgressBar(order.status);

                        // Render danh s√°ch m√≥n ƒÉn + N√∫t ƒëi·ªÅu khi·ªÉn
                        const itemsHtml = order.items.map(item => {
                            const itemId = item.itemId ? item.itemId._id : '';
                            const itemName = item.itemId ? item.itemId.name : 'M√≥n l·ªói';
                            const itemPrice = item.itemId ? (item.itemId.gia || item.itemId.price || 0) : 0;
                            
                            return `
                                <div class="order-item">
                                    <div style="flex: 1;">
                                        <span class="item-name"><strong>${itemName}</strong></span><br>
                                        <span class="item-price">${formatCurrency(itemPrice * item.quantity)}</span>
                                    </div>
                                    <div class="item-controls">
                                        <button class="btn-action btn-dec" title="Gi·∫£m" onclick="goiApiCapNhatMon('${order._id}', '${itemId}', ${item.quantity - 1})">-</button>
                                        <span style="margin: 0 8px; font-weight:bold; min-width: 20px; text-align: center;">${item.quantity}</span>
                                        <button class="btn-action btn-inc" title="TƒÉng" onclick="goiApiCapNhatMon('${order._id}', '${itemId}', ${item.quantity + 1})">+</button>
                                        <button class="btn-action btn-del" title="X√≥a" style="margin-left:10px;" onclick="goiApiCapNhatMon('${order._id}', '${itemId}', 0)">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        // Render HTML cho Card
                        orderCard.innerHTML = `
                            <div class="order-header">
                                <div style="width: 100%; display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <div style="display: flex; align-items: center;">
                                            <strong style="font-size: 1.1rem; color: #333;">B√†n: ${order.banId ? order.banId.soBan : 'Mang v·ªÅ'}</strong>
                                            
                                            <button class="btn-switch-table" onclick="goiApiChuyenBan('${order._id}', '${order.banId ? order.banId.soBan : ''}')">
                                                üîÑ Chuy·ªÉn b√†n
                                            </button>
                                        </div>
                                        <div style="margin-top: 5px; font-size: 0.85rem; color: #777;">
                                            M√£ ƒë∆°n: #${order._id.substring(0, 8)}...
                                        </div>
                                    </div>
                                    <div style="text-align: right; font-size: 0.85rem; color: #666;">
                                        ${new Date(order.createdAt).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}<br>
                                        ${new Date(order.createdAt).toLocaleDateString('vi-VN')}
                                    </div>
                                </div>
                            </div>

                            <div class="order-body">
                                <div class="payment-status" id="payment-status-${order._id}">
                                    ${paymentStatusHtml}
                                </div>

                                <div style="margin-bottom: 15px;">${itemsHtml}</div>

                                ${(order.status === 'M·ªõi' || order.status === 'ƒêang x·ª≠ l√Ω') ? 
                                    `<button class="btn-add-more" onclick="moModalGoiThem('${order._id}')">
                                        ‚ûï G·ªçi th√™m m√≥n t·ª´ Menu
                                    </button>` : ''
                                }

                                <div class="status-container" id="status-container-${order._id}">
                                    ${progressBarHtml}
                                </div>
                            </div>

                            <div class="order-footer">
                                <span>T·ªïng c·ªông:</span>
                                <span style="color: #d32f2f; font-size: 1.3rem;">${formatCurrency(order.totalPrice)}</span>
                            </div>
                        `;
                        container.appendChild(orderCard);
                    });
                } catch (err) {
                    console.error('L·ªói t·∫£i ti·∫øn tr√¨nh:', err);
                    container.innerHTML = `<p style="text-align: center; color: red;">${err.message}</p>`;
                }
            }

            // --- 5. LOGIC CH·∫†Y TRANG (NAVBAR, SOCKET, INIT) ---
            function runPageLogic() {
                loadActiveOrders();
                const urlParams = new URLSearchParams(window.location.search);
                const newOrderId = urlParams.get('newOrder');

                // 2. N·∫øu c√≥ ID ƒë∆°n h√†ng m·ªõi -> T·ª± ƒë·ªông g·ªçi h√†m hi·ªán QR
                if (newOrderId) {
                    console.log("Ph√°t hi·ªán ƒë∆°n h√†ng m·ªõi, ƒëang m·ªü QR:", newOrderId);
                    
                    // ƒê·ª£i 1 ch√∫t ƒë·ªÉ giao di·ªán render xong r·ªìi m·ªõi b·∫≠t
                    setTimeout(() => {
                        showTransferQR(newOrderId);
                        
                        // (T√πy ch·ªçn) X√≥a ID kh·ªèi URL ƒë·ªÉ F5 kh√¥ng b·ªã b·∫≠t l·∫°i
                        window.history.replaceState({}, document.title, "/order-progress.html");
                    }, 1000); 
                }
                const authButton = document.getElementById("authButton");
                const navOrderLink = document.getElementById("nav-order-link");
                const navAdminLink = document.getElementById("nav-admin-link");
                const utilityDropdown = document.getElementById("utilityDropdown");

                if (authButton && navOrderLink && navAdminLink && utilityDropdown) { 
                    if (userInfo) {
                        authButton.textContent = `ƒêƒÉng xu·∫•t (${userInfo.username || ''})`;
                        utilityDropdown.style.display = "inline-block";
                        
                        if (userInfo.role === "admin") {
                            navOrderLink.style.display = "none";
                            navAdminLink.style.display = "inline-block";
                        } else {
                            navOrderLink.style.display = "inline-block";
                            navAdminLink.style.display = "none";
                        }
                        authButton.addEventListener("click", () => {
                            localStorage.clear(); 
                            window.location.href = "/index.html";
                        });
                    } else {
                        authButton.textContent = "ƒêƒÉng nh·∫≠p";
                        utilityDropdown.style.display = "none";
                        navOrderLink.style.display = "none";
                        navAdminLink.style.display = "none";
                        authButton.addEventListener("click", () => {
                            window.location.href = "login.html";
                        });
                    }
                }
                
                // Socket IO
                try {
                    if (!socket) socket = io(); 
                    socket.on('connect', () => console.log('User connected Socket.IO'));

                    socket.on('order_updated', (updatedOrder) => {
                        if (userInfo && updatedOrder.user && (userInfo.userId === updatedOrder.user._id || userInfo.userId === updatedOrder.user)) {
                            
                            showToast(`ƒê∆°n h√†ng #${updatedOrder._id.substring(0, 6)} c·∫≠p nh·∫≠t: ${updatedOrder.status}`);

                            if (updatedOrder.status === 'Ho√†n th√†nh' || updatedOrder.status === 'ƒê√£ h·ªßy') {
                                const card = document.getElementById(`order-card-${updatedOrder._id}`);
                                if (card) card.remove();
                                if (document.querySelectorAll('.order-card').length === 0) {
                                    document.getElementById('order-list-container').innerHTML = '<p style="text-align: center;">B·∫°n kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.</p>';
                                }
                            } else {
                                // C·∫≠p nh·∫≠t l·∫°i UI n·∫øu tr·∫°ng th√°i thay ƒë·ªïi (ƒë·ªÉ update progress bar)
                                loadActiveOrders(); 
                            }
                        }
                    });
                    
                    // L·∫Øng nghe s·ª± ki·ªán update t·ª´ server (do Chatbot ho·∫∑c API kh√°c t√°c ƒë·ªông)
                    socket.on('SERVER_UPDATE_ORDER', (data) => {
                        // ƒê·ªÉ ƒë∆°n gi·∫£n, c·ª© c√≥ signal update l√† reload l·∫°i list cho ch·∫Øc
                        loadActiveOrders();
                    });

                } catch(err) { console.error("Socket Error:", err.message); }
            }

            document.addEventListener('DOMContentLoaded', () => {
                userInfo = JSON.parse(localStorage.getItem("userInfo")); 
                let navbarFile = '/guest-navbar.html';
                if (userInfo && userInfo.role === 'admin') navbarFile = '/admin-navbar.html'; 
                else if (userInfo) navbarFile = '/user-navbar.html'; 
                
                fetch(navbarFile)
                    .then(r => { if(!r.ok) throw new Error('Navbar 404'); return r.text(); })
                    .then(data => {
                        const el = document.getElementById('navbar-placeholder');
                        if (el) el.innerHTML = data;
                        runPageLogic(); 
                    })
                    .catch(e => {
                        console.error(e);
                        runPageLogic(); 
                    });
            });
        </script>
    </body>
    </html>