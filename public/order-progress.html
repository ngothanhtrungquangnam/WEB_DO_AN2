<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ti·∫øn tr√¨nh ƒë∆°n h√†ng</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="/socket.io/socket.io.js"></script>

    <style>
        /* GI·ªÆ NGUY√äN TO√ÄN B·ªò CSS G·ªêC C·ª¶A B·∫†N */
        body { background-color: #f4f4f4; margin: 0; font-family: sans-serif; }
        .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
        h2 { text-align: center; color: #ff7043; margin-bottom: 2rem; }
        .order-card { background: #fff; margin-bottom: 1.5rem; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; transition: all 0.3s; }
        .order-header { padding: 1rem 1.5rem; background: #fffaf7; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .order-body { padding: 1.5rem; }
        .order-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; align-items: center; }
        .order-footer { padding: 1rem 1.5rem; background: #f9f9f9; text-align: right; font-size: 1.2rem; font-weight: bold; border-top: 1px solid #eee; }
        .payment-status-paid { color: #28a745; font-weight: bold; }
        .payment-status-unpaid { color: #fd7e14; font-weight: bold; }
        .payment-status-pending { color: #007bff; font-weight: bold; }
        .item-controls { display: inline-flex; align-items: center; gap: 5px; margin-left: 10px; }
        .btn-action { cursor: pointer; border: 1px solid #ddd; background: #fff; border-radius: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s; }
        .btn-inc { color: green; border-color: #c3e6cb; background-color: #f0fff4; }
        .btn-dec { color: orange; border-color: #ffeeba; background-color: #fff3cd; }
        .btn-del { color: red; border-color: #f5c6cb; background-color: #f8d7da; }
        .btn-switch-table { background-color: #ffc107; border: 1px solid #e0a800; color: #333; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        .btn-add-more { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; font-size: 1rem; margin-top: 15px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: white; margin: 5% auto; border-radius: 12px; width: 95%; max-width: 500px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; background: #fffaf7; display: flex; justify-content: space-between; align-items: center; }
        .close-modal { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .menu-item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .menu-item-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 15px; }
        .btn-select-food { background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; }
        
        #qrModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .qr-modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; position: relative; }
        .btn-finish-transfer { width: 100%; padding: 12px; margin-top: 20px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .timeline-container { margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .timeline-steps { display: flex; justify-content: space-between; position: relative; }
        .timeline-steps::before { content: ''; position: absolute; top: 14px; left: 0; width: 100%; height: 2px; background: #e0e0e0; z-index: 0; }
        .tl-step { position: relative; z-index: 1; text-align: center; flex: 1; }
        .tl-icon { width: 30px; height: 30px; border-radius: 50%; background: #e0e0e0; color: #999; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-size: 0.9rem; border: 2px solid #fff; }
        .tl-text { font-size: 0.75rem; color: #999; font-weight: 500; }
        .tl-step.active .tl-icon { background: #ff6b6b; color: white; }
        .tl-step.active .tl-text { color: #ff6b6b; font-weight: bold; }
        .tl-step.completed .tl-icon { background: #4caf50; color: white; }

        @media screen and (max-width: 768px) {
            body { background-color: #f5f7fa; padding-bottom: 90px; }
            .container { padding: 0; margin: 0; max-width: 100%; }
            h2 { display: none; }
            .order-card { border-radius: 0 0 20px 20px; margin-bottom: 20px; border: none; }
            .order-header { background: linear-gradient(135deg, #ff9a9e 0%, #ff6b6b 100%); color: white; padding: 20px; }
            .order-header strong { font-size: 1.4rem; }
            .timeline-container { background: white; margin: -15px 15px 15px 15px; padding: 20px 10px; border-radius: 12px; z-index: 10; position: relative; }
        }
        /* --- S·ª¨A L·∫†I ƒêO·∫†N N√ÄY TRONG PH·∫¶N STYLE C·ª¶A FILE order-progress.html --- */

/* 1. ƒê·∫£m b·∫£o n·ªôi dung Modal co gi√£n ƒë√∫ng */
.modal-content {
    /* C√°c thu·ªôc t√≠nh c≈© gi·ªØ nguy√™n */
    display: flex;
    flex-direction: column;
    max-height: 85vh; /* Chi·ªÅu cao t·ªëi ƒëa c·ªßa popup l√† 85% m√†n h√¨nh */
}

/* 2. √âp danh s√°ch m√≥n ƒÉn ph·∫£i n·∫±m g·ªçn v√† t·ª± cu·ªôn */
#menu-list-container {
    flex: 1;           /* L·ªánh quan tr·ªçng: Chi·∫øm h·∫øt kho·∫£ng tr·ªëng c√≤n l·∫°i */
    overflow-y: auto;  /* B·∫Øt bu·ªôc hi·ªán thanh cu·ªôn khi danh s√°ch d√†i */
    min-height: 0;     /* Fix l·ªói cu·ªôn tr√™n Firefox/m·ªôt s·ªë tr√¨nh duy·ªát */
    padding: 10px;
    background-color: #fff;
    border-top: 1px solid #eee; /* ƒê∆∞·ªùng k·∫ª nh·∫π ngƒÉn c√°ch v·ªõi ti√™u ƒë·ªÅ */
}

/* 3. L√†m ƒë·∫πp thanh cu·ªôn (Scrollbar) */
#menu-list-container::-webkit-scrollbar {
    width: 6px;
}
#menu-list-container::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 4px;
}
    </style>
</head>
<body>

    <div id="navbar-placeholder"></div>

    <main class="container">
        <h2 id="desktop-title">Ti·∫øn tr√¨nh ƒê∆°n h√†ng</h2>
        <div id="order-list-container">
            <p style="text-align: center; padding: 20px;">ƒêang t·∫£i ƒë∆°n h√†ng c·ªßa b·∫°n...</p>
        </div>
    </main>

    <div id="bottom-nav-placeholder"></div>

    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üçΩÔ∏è Menu G·ªçi Th√™m</h3>
                <span class="close-modal" onclick="dongModalMenu()">&times;</span>
            </div>
            <div id="menu-loading" style="text-align: center; padding: 20px; display: none;">‚è≥ ƒêang t·∫£i...</div>
            <div id="menu-list-container"></div>
        </div>
    </div>

    <div id="qrModal">
        <div class="qr-modal-content">
            <span style="position:absolute; right:15px; top:10px; cursor:pointer; font-size:24px;" onclick="closeQRModal()">&times;</span>
            <h3 style="color:#0056b3; margin-top:0;">Thanh to√°n VietQR</h3>
            <p id="bankNote" style="font-weight:bold; color:#d32f2f; font-size: 0.85rem; background: #fff0f0; padding: 8px; border-radius: 5px;"></p>
            <img id="vietqrImage" src="" style="width:100%; border-radius:10px; border: 1px solid #ddd;">
            <div style="margin-top:10px; text-align:left; background:#f9f9f9; padding:10px; border-radius:8px;">
                <div>S·ªë ti·ªÅn: <b id="qrAmount" style="color:red;"></b></div>
                <div>N·ªôi dung: <b id="qrContent"></b></div>
            </div>
            <button class="btn-finish-transfer" onclick="closeQRModal()">ƒê√£ chuy·ªÉn xong</button>
        </div>
    </div>

    <footer>
        <p style="text-align: center; margin-top: 30px; color: #888; font-size: 0.8rem;">¬© 2025 Qu√°n ƒÇn Ngon 24h</p>
    </footer>

    <script>
        /* ============================================================
            GI·ªÆ NGUY√äN 100% C√ÅC H√ÄM CH·ª®C NƒÇNG C·ª¶A B·∫†N
           ============================================================ */
        let userInfo = JSON.parse(localStorage.getItem("userInfo"));
        let socket = null;
        let currentTargetOrderId = null;
        let qrCheckInterval = null;

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function renderTimeline(status) {
            const steps = [
                { label: 'M·ªõi', icon: 'bi-clipboard-check' },
                { label: 'ƒêang x·ª≠ l√Ω', icon: 'bi-fire' },
                { label: 'Ho√†n th√†nh', icon: 'bi-flag-fill' }
            ];
            if (status === 'ƒê√£ h·ªßy') return `<div style="text-align:center; color:red; padding:15px; font-weight:bold;">‚ùå ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy</div>`;
            let activeIndex = (status === 'ƒêang x·ª≠ l√Ω') ? 1 : (status === 'Ho√†n th√†nh' ? 2 : 0);
            let html = '<div class="timeline-container"><div class="timeline-steps">';
            steps.forEach((step, index) => {
                let cls = 'tl-step' + (index <= activeIndex ? ' active' : '') + (index < activeIndex ? ' completed' : '');
                html += `<div class="${cls}"><div class="tl-icon"><i class="bi ${step.icon}"></i></div><div class="tl-text">${step.label}</div></div>`;
            });
            return html + '</div></div>';
        }

        function renderPaymentStatus(order) {
            const total = order.totalPrice || 0;
            const paid = order.amountPaid || 0;
            const remain = total - paid;
            if (order.trangThaiThanhToan === 'ƒê√£ thanh to√°n' || remain <= 0) return `<span class="payment-status-paid">‚úÖ ƒê√£ thanh to√°n</span>`;
            if (order.paymentMethod === 'Ti·ªÅn m·∫∑t' || order.paymentMethod === 'cash') return `<span class="payment-status-unpaid">üíµ T·∫°i qu·∫ßy: ${formatCurrency(remain)}</span>`;
            return `<span class="payment-status-pending">‚è≥ Ch·ªù: ${formatCurrency(remain)}</span><br><button onclick="showTransferQR('${order._id}', ${remain})" style="color:#007bff; border:none; background:none; text-decoration:underline; cursor:pointer;">[üì≤ L·∫•y m√£ QR]</button>`;
        }

    // 1. S·ª¨A H√ÄM HI·ªÇN TH·ªä (Truy·ªÅn status v√†o c√°c n√∫t b·∫•m)
        async function loadActiveOrders() {
            const container = document.getElementById('order-list-container');
            if (!userInfo?.token) { container.innerHTML = '<p style="text-align:center;color:red">Vui l√≤ng ƒëƒÉng nh·∫≠p!</p>'; return; }
            try {
                const res = await fetch(`/api/donhang/my-active?userId=${userInfo.userId || userInfo._id}`, { headers: { 'Authorization': `Bearer ${userInfo.token}` } });
                const data = await res.json();
                const active = data.filter(o => o.status === 'M·ªõi' || o.status === 'ƒêang x·ª≠ l√Ω'); // Ch·ªâ l·∫•y ƒë∆°n ch∆∞a ho√†n th√†nh h·∫≥n
                
                if (!active.length) { container.innerHTML = '<p style="text-align:center;padding:20px">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang x·ª≠ l√Ω.</p>'; return; }
                
                container.innerHTML = '';
                active.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    
                    // --- LOGIC KI·ªÇM TRA TR·∫†NG TH√ÅI ƒê·ªÇ ·∫®N/HI·ªÜN N√öT ---
                    // N·∫øu ƒëang x·ª≠ l√Ω -> Disable n√∫t
                    const isLocked = (order.status === 'ƒêang x·ª≠ l√Ω' || order.status === 'Ho√†n th√†nh');
                    const disabledAttr = isLocked ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : '';
                    
                    card.innerHTML = `
                        <div class="order-header">
                            <div style="flex:1">
                                <strong>B√†n: ${order.banId?.soBan || 'Mang v·ªÅ'}</strong>
                                <button class="btn-switch-table" ${disabledAttr} onclick="goiApiChuyenBan('${order._id}', '${order.banId?.soBan || ''}', '${order.status}')">üîÑ ƒê·ªïi b√†n</button>
                                <div style="font-size:0.75rem; opacity:0.7">ID: #${order._id.substring(0,8)}</div>
                            </div>
                            <div style="text-align:right; font-size:0.8rem">${new Date(order.createdAt).toLocaleString('vi-VN')}</div>
                        </div>
                        ${renderTimeline(order.status)}
                        <div class="order-body">
                            <div style="text-align:right;margin-bottom:10px">${renderPaymentStatus(order)}</div>
                            ${order.items.map(item => `
                                <div class="order-item">
                                    <div style="flex:1"><span>${item.itemId?.name || 'M√≥n ƒë√£ x√≥a'}</span><br><small>${formatCurrency(item.itemId?.price * item.quantity)}</small></div>
                                    <div class="item-controls">
                                        <button class="btn-action btn-dec" ${disabledAttr} onclick="goiApiCapNhatMon('${order._id}', '${item.itemId?._id}', ${item.quantity - 1}, '${order.status}')">-</button>
                                        <b style="width:20px;text-align:center">${item.quantity}</b>
                                        <button class="btn-action btn-inc" ${disabledAttr} onclick="goiApiCapNhatMon('${order._id}', '${item.itemId?._id}', ${item.quantity + 1}, '${order.status}')">+</button>
                                        <button class="btn-action btn-del" ${disabledAttr} onclick="goiApiCapNhatMon('${order._id}', '${item.itemId?._id}', 0, '${order.status}')">üóëÔ∏è</button>
                                    </div>
                                </div>`).join('')}
                            
                            <button class="btn-add-more" ${disabledAttr} onclick="moModalGoiThem('${order._id}', '${order.status}')">
                                <i class="bi bi-plus-circle"></i> G·ªçi th√™m m√≥n
                            </button>
                        </div>
                        <div class="order-footer">T·ªïng: <span style="color:red">${formatCurrency(order.totalPrice)}</span></div>`;
                    container.appendChild(card);
                });
            } catch (e) { console.error(e); }
        }

        // 2. S·ª¨A H√ÄM C·∫¨P NH·∫¨T M√ìN (Th√™m tham s·ªë status)
       // --- H√ÄM C·∫¨P NH·∫¨T & X√ìA M√ìN (ƒê√É C√ì ƒêI·ªÄU KI·ªÜN CH·∫∂N) ---
async function goiApiCapNhatMon(orderId, itemId, quantity, status) {
    
    // üî• 1. KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN CH·∫∂N (QUAN TR·ªåNG)
    // N·∫øu tr·∫°ng th√°i l√† "ƒêang x·ª≠ l√Ω" (Admin ƒë√£ duy·ªát) ho·∫∑c "Ho√†n th√†nh"
    // Th√¨ CH·∫∂N LU√îN, kh√¥ng cho x√≥a hay s·ª≠a g√¨ c·∫£.
    if (status === 'ƒêang x·ª≠ l√Ω' || status === 'Ho√†n th√†nh') {
        alert("‚õî ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c nh√† b·∫øp ti·∫øp nh·∫≠n x·ª≠ l√Ω. B·∫°n kh√¥ng th·ªÉ x√≥a m√≥n n√†y ƒë∆∞·ª£c n·ªØa!");
        return; // D·ª´ng l·∫°i ngay l·∫≠p t·ª©c
    }

    // üî• 2. LOGIC X√ìA (Khi quantity = 0)
    if (quantity === 0) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA m√≥n n√†y kh·ªèi ƒë∆°n kh√¥ng?")) {
            return; // N·∫øu kh√°ch b·∫•m H·ªßy th√¨ kh√¥ng l√†m g√¨
        }
    }

    // üî• 3. G·ªåI API (Ch·ªâ ch·∫°y xu·ªëng ƒë√¢y n·∫øu ch∆∞a b·ªã ch·∫∑n)
    try {
        const res = await fetch('/api/donhang/update-item', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ orderId, itemId, quantity }) 
        });
        
        const data = await res.json();
        
        if (data.success) { 
            loadActiveOrders(); // T·∫£i l·∫°i danh s√°ch
        } else {
            alert(data.message || "L·ªói c·∫≠p nh·∫≠t!");
        }
    } catch (e) { 
        alert("L·ªói k·∫øt n·ªëi Server!"); 
    }
}
        // 3. S·ª¨A H√ÄM M·ªû MENU G·ªåI TH√äM (Th√™m tham s·ªë status)
        async function moModalGoiThem(orderId, status) {
            // üî• CH·∫∂N KH√îNG CHO M·ªû MENU N·∫æU ƒêANG X·ª¨ L√ù
            if (status === 'ƒêang x·ª≠ l√Ω' || status === 'Ho√†n th√†nh') {
                alert("‚õî ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c ch·∫ø bi·∫øn. Vui l√≤ng t·∫°o ƒë∆°n m·ªõi n·∫øu mu·ªën g·ªçi th√™m!");
                return;
            }

            currentTargetOrderId = orderId;
            const modal = document.getElementById('menuModal');
            modal.style.display = 'flex'; // D√πng flex ƒë·ªÉ canh gi·ªØa ƒë·∫πp h∆°n
            document.getElementById('menu-loading').style.display = 'block';
            try {
                const res = await fetch('/api/monan');
                const foods = await res.json();
                document.getElementById('menu-loading').style.display = 'none';
                document.getElementById('menu-list-container').innerHTML = foods.map(f => `
                    <div class="menu-item-row">
                        <img src="${f.image}" class="menu-item-thumb" onerror="this.src='/images/default-food.png'">
                        <div style="flex:1"><b>${f.name}</b><br><small>${formatCurrency(f.price)}</small></div>
                        <button class="btn-select-food" onclick="chonMonGoiThem('${f._id}')">+ Th√™m</button>
                    </div>`).join('');
            } catch (e) { alert("L·ªói t·∫£i menu!"); }
        }
        
        // H√†m ch·ªçn m√≥n g·ªçi th√™m (Logic c≈© v·∫´n ·ªïn v√¨ ƒë√£ ch·∫∑n ·ªü b∆∞·ªõc m·ªü modal, nh∆∞ng th√™m check cho ch·∫Øc)
        async function chonMonGoiThem(foodId) {
             // L·∫•y l·∫°i ƒë∆°n h√†ng hi·ªán t·∫°i ƒë·ªÉ check status l·∫ßn cu·ªëi (cho an to√†n)
             // Nh∆∞ng ƒë·ªÉ nhanh g·ªçn, ta tin t∆∞·ªüng v√†o vi·ªác ƒë√£ ch·∫∑n ·ªü b∆∞·ªõc m·ªü Modal.
            const res = await fetch(`/api/donhang/details/${currentTargetOrderId}`);
            const order = await res.json();
            
            // Check status l·∫ßn n·ªØa (ƒë·ªÅ ph√≤ng m·ªü menu xong th√¨ b·∫øp b·∫•m nh·∫≠n ƒë∆°n)
            if(order.status === 'ƒêang x·ª≠ l√Ω') {
                 alert("B·∫øp v·ª´a nh·∫≠n ƒë∆°n! Kh√¥ng th·ªÉ th√™m m√≥n.");
                 dongModalMenu();
                 loadActiveOrders();
                 return;
            }

            const exist = order.items.find(i => (i.itemId._id || i.itemId) === foodId);
            // G·ªçi api c·∫≠p nh·∫≠t (truy·ªÅn status 'M·ªõi' gi·∫£ ƒë·ªãnh v√¨ ƒë√£ check ·ªü tr√™n)
            await goiApiCapNhatMon(currentTargetOrderId, foodId, exist ? exist.quantity + 1 : 1, 'M·ªõi');
            dongModalMenu();
        }
        
        // C·∫≠p nh·∫≠t h√†m chuy·ªÉn b√†n ƒë·ªÉ ch·∫∑n lu√¥n
        async function goiApiChuyenBan(orderId, oldTable, status) {
             if (status === 'ƒêang x·ª≠ l√Ω' || status === 'Ho√†n th√†nh') {
                alert("‚õî ƒê∆°n ƒëang ch·∫ø bi·∫øn, kh√¥ng th·ªÉ ƒë·ªïi b√†n!");
                return;
            }
            const newTable = prompt(`ƒê∆°n ƒëang ·ªü b√†n ${oldTable}. Nh·∫≠p s·ªë b√†n m·ªõi:`);
            if (!newTable) return;
            try {
                const res = await fetch('/api/donhang/switch-table', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ orderId, newTableId: newTable }) });
                const data = await res.json();
                alert(data.message); if (data.success) loadActiveOrders();
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }
        function dongModalMenu() { document.getElementById('menuModal').style.display = 'none'; }

        async function showTransferQR(orderId, amount) {
            const modal = document.getElementById('qrModal');
            modal.style.display = 'flex';
            try {
                const res = await fetch('/api/payment/create-vietqr', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ orderId, amount }) });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('vietqrImage').src = data.qrCodeUrl;
                    document.getElementById('qrAmount').innerText = parseInt(data.amount).toLocaleString('vi-VN') + 'ƒë';
                    document.getElementById('qrContent').innerText = data.memo;
                    document.getElementById('bankNote').innerText = `${data.bankInfo.bankId} - ${data.bankInfo.accountNo}`;
                }
            } catch (e) { alert("L·ªói t·∫°o QR!"); }
        }
        function closeQRModal() { document.getElementById('qrModal').style.display = 'none'; }

        /* ============================================================
            KH·ªûI T·∫†O V√Ä ƒê·ªíNG B·ªò GIAO DI·ªÜN
           ============================================================ */
        document.addEventListener('DOMContentLoaded', () => {
            let nav = userInfo?.role==='admin' ? 'admin-navbar.html' : (userInfo ? 'user-navbar.html' : 'guest-navbar.html');
            fetch(nav).then(r=>r.text()).then(h => document.getElementById('navbar-placeholder').innerHTML = h);

            loadActiveOrders();

            if (typeof io !== 'undefined') {
                socket = io();
                socket.on('order_updated', (o) => {
                    const uId = o.user?._id || o.user;
                    if(userInfo && (userInfo.userId === uId)) loadActiveOrders();
                });
            }
        });

        window.onclick = function(e) {
            if (e.target == document.getElementById('menuModal')) dongModalMenu();
            if (e.target == document.getElementById('qrModal')) closeQRModal();
        }
    </script>

    <script src="script.js"></script>
    <script src="/js/aiChat.js"></script>
    
</body>
</html>