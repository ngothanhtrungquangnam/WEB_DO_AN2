<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin ng∆∞·ªùi d√πng</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="/socket.io/socket.io.js"></script>
    
   
</head>
<body>

    <div id="navbar-placeholder"></div>

   <main class="profile-new-design">
    <div class="profile-header-section">
        <div class="avatar-container">
            <img id="user-avatar-img" src="https://ui-avatars.com/api/?name=User&background=ff7043&color=fff&size=128" alt="Avatar">
            <div class="camera-badge"><i class="bi bi-camera-fill"></i></div>
        </div>
        <div id="userInfoHeader" class="header-info">
            <h2 class="user-display-name">ƒêang t·∫£i...</h2>
            <span class="user-badge"><i class="bi bi-patch-check-fill"></i> Th√†nh vi√™n th√¢n thi·∫øt</span>
        </div>
    </div>

  <div class="profile-menu-container">
    
    <div id="authMenuContent" class="menu-group">
        <div class="menu-item-row" onclick="togglePasswordForm()">
            <div class="menu-item-left">
                <div class="icon-box security"><i class="bi bi-shield-lock-fill"></i></div>
                <span>B·∫£o m·∫≠t & M·∫≠t kh·∫©u</span>
            </div>
            <i class="bi bi-chevron-down arrow-icon"></i>
        </div>

        <div id="passwordFormContainer" class="collapsible-form" style="display:none;">
            <form id="passwordForm">
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                    <input type="password" id="oldPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="newPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="form-group">
                    <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="confirmPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-save-modern">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
                <p id="msg"></p>
            </form>
        </div>

        <div id="menu-history" class="menu-item-row" onclick="window.location.href='order-history.html'">
            <div class="menu-item-left">
                <div class="icon-box history"><i class="bi bi-clock-history"></i></div>
                <span>L·ªãch s·ª≠ ƒë·∫∑t m√≥n</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </div>

        <div id="menu-progress" class="menu-item-row" onclick="window.location.href='order-progress.html'">
            <div class="menu-item-left">
                <div class="icon-box status"><i class="bi bi-truck"></i></div>
                <span>ƒê∆°n h√†ng ƒëang x·ª≠ l√Ω</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </div>
    </div>

    <div class="menu-group">
        <div class="menu-item-row" onclick="handleAuthAction()">
            <div class="menu-item-left">
                <div class="icon-box logout"><i class="bi bi-box-arrow-right"></i></div>
                <span id="authText" class="logout-text">ƒêƒÉng xu·∫•t</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </div>
    </div>
</div>
    <div class="footer-action">
        <button class="btn-outline-home" onclick="window.location.href='index.html'">
            <i class="bi bi-house"></i> Quay v·ªÅ Trang ch·ªß
        </button>
    </div>
</main>
    <div id="bottom-nav-placeholder"></div>

<script>
    let userInfo = null;

    // --- Logic ƒê·ªïi m·∫≠t kh·∫©u ---
    function togglePasswordForm() {
        const form = document.getElementById("passwordFormContainer"); // S·ª≠a l·∫°i ID cho ƒë√∫ng v·ªõi HTML
        if (form) {
            form.style.display = form.style.display === "none" ? "block" : "none";
        }
    }
    
    async function handlePasswordSubmit(e) {
        e.preventDefault();
        const msg = document.getElementById('msg');
        const btn = e.target.querySelector('button[type="submit"]');
        const oldPass = document.getElementById('oldPass').value;
        const newPass = document.getElementById('newPass').value;
        const confirmPass = document.getElementById('confirmPass').value;

        if (!userInfo || !userInfo.token || newPass !== confirmPass) {
            msg.textContent = newPass !== confirmPass ? '‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!' : 'L·ªói: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.';
            msg.className = 'error';
            return;
        }

        btn.disabled = true; btn.textContent = 'ƒêang l∆∞u...';
        try {
            const res = await fetch('/api/auth/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userInfo.token}` },
                body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })
            });
            const data = await res.json();
            
            if (res.ok) {
                msg.textContent = '‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!';
                msg.className = 'success';
                e.target.reset();
            } else {
                msg.textContent = `‚ö†Ô∏è ${data.message}`;
                msg.className = 'error';
            }
        } catch (err) {
            msg.textContent = 'üö´ L·ªói k·∫øt n·ªëi server!';
            msg.className = 'error';
        } finally {
            btn.disabled = false; btn.textContent = 'C·∫≠p nh·∫≠t m·∫≠t kh·∫©u';
        }
    }
    
    function handleAuthAction() {
        if (userInfo) {
            if(confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒêƒÉng xu·∫•t t√†i kho·∫£n ${userInfo.username}?`)) {
                localStorage.removeItem("userInfo");
                localStorage.removeItem("clientCart"); 
                window.location.href = "/index.html"; 
            }
        } else {
            window.location.href = "login.html";
        }
    }

    // === üî• H√ÄM HI·ªÇN TH·ªä (ƒê√É S·ª¨A L·ªñI ·∫®N MENU ADMIN) üî• ===
    function renderProfileAndButtons() {
        const userHeaderInfo = document.getElementById("userInfoHeader");
        const avatarImg = document.getElementById("user-avatar-img");
        const authText = document.getElementById("authText");

        // L·∫•y 2 m·ª•c c·∫ßn ·∫©n
        const menuHistory = document.getElementById("menu-history");
        const menuProgress = document.getElementById("menu-progress");

        if (!userInfo) {
            document.querySelector(".user-display-name").innerText = "Kh√°ch v√£ng lai";
            authText.innerText = "ƒêƒÉng nh·∫≠p";
            document.getElementById("authMenuContent").style.display = "none";
        } else {
            document.querySelector(".user-display-name").innerText = userInfo.username || "Ng∆∞·ªùi d√πng";
            authText.innerText = "ƒêƒÉng xu·∫•t";
            document.getElementById("authMenuContent").style.display = "block";
            
            avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userInfo.username)}&background=ff7043&color=fff&size=128`;

            // === KI·ªÇM TRA ADMIN ===
            if (userInfo.role === 'admin') {
                // D√πng setProperty v·ªõi 'important' ƒë·ªÉ th·∫Øng ƒë∆∞·ª£c file CSS
                if(menuHistory) menuHistory.style.setProperty("display", "none", "important");
                if(menuProgress) menuProgress.style.setProperty("display", "none", "important");
            } else {
                if(menuHistory) menuHistory.style.display = "flex";
                if(menuProgress) menuProgress.style.display = "flex";
            }
        }
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        userInfo = JSON.parse(localStorage.getItem("userInfo"));
        
        // Ch·∫°y h√†m hi·ªÉn th·ªã
        renderProfileAndButtons();
        
        const passForm = document.getElementById('passwordForm');
        if(passForm) passForm.addEventListener('submit', handlePasswordSubmit);

        // T·∫£i Header & Footer
        let navbarFile = '/guest-navbar.html';
        let bottomNavFile = '/bottom-nav.html';

        if (userInfo && userInfo.role === 'admin') {
            navbarFile = '/admin-navbar.html';
        } else if (userInfo) {
            navbarFile = '/user-navbar.html';
        } else {
            bottomNavFile = '/guest-bottom-nav.html'; 
        }

        fetch(navbarFile)
            .then(r => r.text())
            .then(html => {
                document.getElementById('navbar-placeholder').innerHTML = html;
            })
            .catch(err => console.error("L·ªói t·∫£i Header:", err));

        fetch(bottomNavFile)
            .then(r => r.text())
            .then(html => {
                document.getElementById('bottom-nav-placeholder').innerHTML = html;
                
                const navProfile = document.getElementById('nav-profile');
                if(navProfile) navProfile.classList.add('active');

                // Script cho Utility menu
                const s = document.createElement("script");
                s.innerHTML = `
                    function toggleUtilityMenu(){ const m=document.getElementById('utility-menu'),o=document.getElementById('utility-overlay'); if(m){m.classList.add('show');o.classList.add('show');document.body.style.overflow='hidden';}}
                    function closeUtilityMenu(){ const m=document.getElementById('utility-menu'),o=document.getElementById('utility-overlay'); if(m){m.classList.remove('show');o.classList.remove('show');document.body.style.overflow='';}}
                `;
                document.body.appendChild(s);
            })
            .catch(err => console.error("L·ªói t·∫£i Bottom Nav:", err));
    });
</script>
</body>
</html>