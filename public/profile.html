<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin ng∆∞·ªùi d√πng</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        body {
            font-family: "Poppins", sans-serif;
            background: linear-gradient(135deg, #ffe0b2, #ffcc80);
            min-height: 100vh;
            margin: 0;
        }
        .profile-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            min-height: calc(100vh - 100px); 
        }
        .profile-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 360px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .avatar { font-size: 3rem; color: #ff7043; margin-bottom: 0.5rem; }
        h2 { color: #ff7043; margin-bottom: 1.2rem; font-weight: 700; font-size: 1.4rem; }
        .info { text-align: left; color: #333; line-height: 1.6; font-size: 1rem; margin-bottom: 1.5rem; }
        .info strong { color: #ff7043; }
        .btn { background-color: #ff7043; color: #fff; border: none; padding: 10px 18px; border-radius: 10px; font-size: 1rem; margin: 5px; cursor: pointer; transition: 0.3s ease; }
        .btn:hover { background-color: #f4511e; transform: scale(1.05); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .input-group { text-align: left; margin: 10px 0; }
        .input-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 5px; }
        #msg { margin-top: 10px; font-weight: 500; }
        #msg.success { color: green; }
        #msg.error { color: red; }
    </style>
</head>
<body>

    <div id="navbar-placeholder"></div>

    <main class="profile-wrapper">
        
        <div class="profile-card">
            <div class="avatar">üë§</div>
            <h2>Th√¥ng tin ng∆∞·ªùi d√πng</h2>
            <div id="userInfo" class="info"></div>
            <button class="btn" onclick="togglePasswordForm()">üîÑ ƒê·ªïi m·∫≠t kh·∫©u</button>
            <button class="btn" onclick="goBack()">‚¨Ö Quay v·ªÅ trang ch·ªß</button>
            <form id="passwordForm" style="display:none; margin-top:1rem;">
                <div class="input-group">
                    <label for="oldPass">M·∫≠t kh·∫©u c≈©:</label>
                    <input type="password" id="oldPass" required>
                </div>
                <div class="input-group">
                    <label for="newPass">M·∫≠t kh·∫©u m·ªõi:</label>
                    <input type="password" id="newPass" required>
                </div>
                <div class="input-group">
                    <label for="confirmPass">X√°c nh·∫≠n m·∫≠t kh·∫©u:</label>
                    <input type="password" id="confirmPass" required>
                </div>
                <button type="submit" class="btn">üíæ L∆∞u thay ƒë·ªïi</button>
                <p id="msg"></p>
            </form>
        </div>
        
    </main>
    
    <script>
        // === BI·∫æN GLOBAL (GI·ªÆ NGUY√äN) ===
        let userInfo = null;

        // === C√ÅC H√ÄM C≈® C·ª¶A B·∫†N (GI·ªÆ NGUY√äN) ===
        function togglePasswordForm() {
            // (Code gi·ªØ nguy√™n)
            const form = document.getElementById("passwordForm");
            form.style.display = form.style.display === "none" ? "block" : "none";
        }

        function goBack() {
            // (Code gi·ªØ nguy√™n)
            window.location.href = "index.html";
        }

        async function handlePasswordSubmit(e) {
            // (Code gi·ªØ nguy√™n)
            e.preventDefault();
            const msg = document.getElementById('msg');
            const submitButton = e.target.querySelector('button[type="submit"]');
            msg.textContent = '';
            msg.classList.remove('success', 'error');
            submitButton.disabled = true;
            submitButton.textContent = 'ƒêang l∆∞u...';
            const oldPassword = document.getElementById('oldPass').value;
            const newPassword = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;
            const token = userInfo ? userInfo.token : null;
            if (!token) {
                msg.textContent = 'L·ªói: Kh√¥ng t√¨m th·∫•y token. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                msg.classList.add('error');
                submitButton.disabled = false;
                submitButton.textContent = 'üíæ L∆∞u thay ƒë·ªïi';
                return;
            }
            if (newPassword !== confirmPass) {
                msg.textContent = '‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!';
                msg.classList.add('error');
                submitButton.disabled = false;
                submitButton.textContent = 'üíæ L∆∞u thay ƒë·ªïi';
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ oldPassword, newPassword })
                });
                const data = await response.json();
                if (response.ok) {
                    msg.textContent = '‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!';
                    msg.classList.add('success');
                    document.getElementById('oldPass').value = '';
                    document.getElementById('newPass').value = '';
                    document.getElementById('confirmPass').value = '';
                } else {
                    msg.textContent = `‚ö†Ô∏è ${data.message || 'L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u'}`;
                    msg.classList.add('error');
                }
            } catch (err) {
                console.error(err);
                msg.textContent = 'üö´ Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!';
                msg.classList.add('error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'üíæ L∆∞u thay ƒë·ªïi';
            }
        }

        // === H√ÄM CH·ª®A LOGIC C≈® C·ª¶A B·∫†N (GI·ªÆ NGUY√äN) ===
        function runPageLogic() {
            // (Code n√†y gi·ªëng h·ªát code c≈© trong DOMContentLoaded c·ªßa b·∫°n)
            const container = document.getElementById("userInfo");
            if (!userInfo) {
                container.innerHTML = `<p style="color:red;">‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.</p>`;
                const changePassBtn = document.querySelector('button[onclick="togglePasswordForm()"]');
                if (changePassBtn) changePassBtn.style.display = 'none';
            } else if (!userInfo.username) {
                container.innerHTML = `<p style="color:red;">‚ö†Ô∏è L·ªói hi·ªÉn th·ªã th√¥ng tin. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.</p>`;
            } else {
                container.innerHTML = `
                    <p><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> ${userInfo.username}</p>
                    <p><strong>Vai tr√≤:</strong> ${userInfo.role}</p>
                    <p><strong>M·∫≠t kh·∫©u:</strong> üîí</p>
                `;
            }
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordSubmit);

            // --- Code logic cho Header (Gi·ªØ nguy√™n) ---
            const authButton = document.getElementById("authButton");
            const navOrderLink = document.getElementById("nav-order-link");
            const navAdminLink = document.getElementById("nav-admin-link");
            const utilityDropdown = document.getElementById("utilityDropdown");

            if (authButton && navOrderLink && navAdminLink) { 
                if (userInfo) {
                    authButton.textContent = `ƒêƒÉng xu·∫•t (${userInfo.username || ''})`;
                    authButton.style.width = 'auto'; 
                    authButton.style.padding = '8px 16px';
                    if(utilityDropdown) utilityDropdown.style.display = "inline-block";
                    if (userInfo.role === "admin") {
                        if(navOrderLink) navOrderLink.style.display = "none";
                        if(navAdminLink) navAdminLink.style.display = "inline-block";
                    } else {
                        if(navOrderLink) navOrderLink.style.display = "inline-block";
                        if(navAdminLink) navAdminLink.style.display = "none";
                    }
                    authButton.addEventListener("click", () => {
                        localStorage.removeItem("userInfo");
                        localStorage.removeItem("clientCart"); 
                        window.location.href = "/index.html";
                    });
                } else {
                    authButton.textContent = "ƒêƒÉng nh·∫≠p";
                    if(utilityDropdown) utilityDropdown.style.display = "none";
                    if(navOrderLink) navOrderLink.style.display = "none";
                    if(navAdminLink) navAdminLink.style.display = "none";
                    authButton.addEventListener("click", () => {
                        window.location.href = "login.html";
                    });
                }
            } else {
                 console.error("L·ªói: Kh√¥ng t√¨m th·∫•y c√°c n√∫t header trong runPageLogic.");
            }
        }
        // === K·∫æT TH√öC H√ÄM LOGIC C≈® ===


        // ***** B∆Ø·ªöC 2: CODE "L·∫ÆP R√ÅP" M·ªöI (ƒê√É THAY TH·∫æ CODE C≈®) *****
        document.addEventListener('DOMContentLoaded', () => {
            // L·∫•y userInfo tr∆∞·ªõc
            userInfo = JSON.parse(localStorage.getItem("userInfo")); // G√°n gi√° tr·ªã cho bi·∫øn global

            // Quy·∫øt ƒë·ªãnh file navbar c·∫ßn t·∫£i d·ª±a tr√™n vai tr√≤
            let navbarFile = '/user-navbar.html'; // M·∫∑c ƒë·ªãnh l√† user
            if (userInfo && userInfo.role === 'admin') {
                navbarFile = '/admin-navbar.html'; // N·∫øu l√† admin th√¨ ƒë·ªïi file
            }
            
            // B·∫Øt ƒë·∫ßu t·∫£i file navbar t∆∞∆°ng ·ª©ng
            fetch(navbarFile)
                .then(response => {
                    if (!response.ok) throw new Error(`Kh√¥ng t√¨m th·∫•y file ${navbarFile}`);
                    return response.text();
                })
                .then(data => {
                    // 1. L·∫Øp menu v√†o
                    const navbarPlaceholder = document.getElementById('navbar-placeholder');
                    if (navbarPlaceholder) {
                        navbarPlaceholder.innerHTML = data;
                    } else {
                        console.error("Kh√¥ng t√¨m th·∫•y th·∫ª #navbar-placeholder!");
                        return; 
                    }
                    
                    // 2. Ch·∫°y logic c·ªßa trang (h√†m runPageLogic ƒë√£ c√≥ ·ªü tr√™n)
                    if (typeof runPageLogic === 'function') {
                        runPageLogic(); 
                    } else {
                         console.error("Kh√¥ng t√¨m th·∫•y h√†m runPageLogic()!");
                    }
                })
                .catch(error => {
                    console.error('L·ªói t·∫£i menu:', error);
                    const navbarPlaceholder = document.getElementById('navbar-placeholder');
                     if (navbarPlaceholder) {
                         navbarPlaceholder.innerHTML = `<p style="color:red; text-align:center;">L·ªñI T·∫¢I MENU (${error.message})</p>`;
                     }
                });
        });
    </script>
    <script src="/socket.io/socket.io.js"></script>
<script src="js/chatbox.js"></script>

</body>
</html>