<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</title>
    <link rel="stylesheet" href="style.css" />
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        .actions-cell { white-space: nowrap; text-align: center; }
        .btn-action { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin: 2px; color: white; transition: opacity 0.2s ease; }
        .btn-action:hover { opacity: 0.85; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-process { background-color: #007bff; }
        .btn-complete { background-color: #28a745; }
        .btn-cancel { background-color: #dc3545; }
        .admin-page { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
        .admin-page h2 { text-align: center; color: #333; margin-bottom: 2rem; font-weight: 600; }
        .admin-page table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        .admin-page thead th { background-color: #f8f9fa; padding: 12px 10px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
        .admin-page tbody td { padding: 10px 10px; border-bottom: 1px solid #eee; vertical-align: top; color: #555; line-height: 1.5; }
        .admin-page th:nth-child(2), .admin-page td:nth-child(2),
        .admin-page th:nth-child(7), .admin-page td:nth-child(7),
        .admin-page th:nth-child(8), .admin-page td:nth-child(8),
        .admin-page th:nth-child(9), .admin-page td:nth-child(9) { text-align: center; vertical-align: middle; }
        .admin-page th:nth-child(6), .admin-page td:nth-child(6) { text-align: right; font-weight: 500; white-space: nowrap; }
        .admin-page td:nth-child(4) div { margin-bottom: 3px; }
        .admin-page tbody tr:last-child td { border-bottom: none; }
        .admin-page tbody tr:hover { background-color: #f1f1f1; }
        
        /* Cáº§n thÃªm CSS cho Tráº¡ng thÃ¡i thanh toÃ¡n Ä‘á»ƒ Ä‘áº¹p hÆ¡n (TÃ´i sáº½ giá»¯ mÃ u cÅ© cá»§a báº¡n) */
    </style>
    
    <script>
    function showSection(id) {
        document.querySelectorAll('#history, #payment, #profile').forEach(sec => sec.style.display = 'none');
        const activeSection = document.getElementById(id);
        if (activeSection) {
            activeSection.style.display = 'block';
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    </script>
</head>

<body>
    <div id="navbar-placeholder"></div>

    <main class="admin-page">
        <h2>ğŸ“‹ Danh sÃ¡ch Ä‘Æ¡n hÃ ng</h2>
        <div style="background: #e3f2fd; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #90caf9; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0 0 5px 0; color: #0d47a1;">ğŸ¦ Cáº¥u hÃ¬nh NgÃ¢n hÃ ng</h3>
                <p style="margin: 0; font-size: 0.95rem;">Äang dÃ¹ng: <span id="currentBankStatus" style="font-weight: bold; color: green;">Máº·c Ä‘á»‹nh (ChÃ­nh)</span></p>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="switchBank('MAIN')" style="padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    âœ… DÃ¹ng MB Bank
                </button>
                <button onclick="switchBank('BACKUP')" style="padding: 10px 15px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    âš ï¸ DÃ¹ng BIDV (Dá»± phÃ²ng)
                </button>
            </div>
        </div>
        <table>
            <thead>
    <tr>
        <th>Thá»i gian</th> 
        <th>BÃ n sá»‘</th> 
        <th>TÃªn khÃ¡ch</th> 
        <th>MÃ³n Äƒn (SL)</th> 
        <th>Ghi chÃº</th> 
        <th>Tá»•ng tiá»n</th> 
        <th>Thanh toÃ¡n</th> 
        <th>Tráº¡ng thÃ¡i</th> 
        <th>HÃ nh Ä‘á»™ng</th> </tr>
</thead>
            <tbody id="orderTableBody">
                <tr><td colspan="8" style="text-align: center;">Äang táº£i dá»¯ liá»‡u...</td></tr>
            </tbody>
        </table>
    </main>

    <footer>Â© 2025 QuÃ¡n Ä‚n Ngon 24h</footer>

   <script>
Â  Â  // === BIáº¾N GLOBAL ===
Â  Â  let userInfo = null;
Â  Â  let tableBody = null; 
Â  Â  // Biáº¿n currentTargetSocketId khÃ´ng cáº§n á»Ÿ Ä‘Ã¢y ná»¯a, chatbox.js tá»± giá»¯.

Â  Â  // === CÃC HÃ€M Xá»¬ LÃ NÃšT (GIá»® NGUYÃŠN) ===
Â  Â  function showToast(message) {
Â  Â  Â  Â  if (typeof globalShowToast === 'function') { globalShowToast(message); }
Â  Â  Â  Â  else { alert(message); }
Â  Â  }// --- HÃ€M Xá»¬ LÃ NÃšT Báº¤M ---
async function switchBank(type) {
        if(!confirm(`Báº¡n cháº¯c cháº¯n muá»‘n chuyá»ƒn sang dÃ¹ng tÃ i khoáº£n ${type === 'MAIN' ? 'ChÃ­nh (MB)' : 'Dá»± phÃ²ng (BIDV)'}?`)) return;

        try {
            const token = userInfo?.token; // Láº¥y token tá»« biáº¿n global userInfo
            const res = await fetch('/api/payment/switch-bank', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ type: type })
            });

            const data = await res.json();
            
            if (res.ok) {
                alert("âœ… " + data.message);
                // Cáº­p nháº­t giao diá»‡n chá»¯
                const label = type === 'MAIN' ? 'MB Bank (ChÃ­nh)' : 'BIDV (Dá»± phÃ²ng)';
                const color = type === 'MAIN' ? 'green' : '#e65100';
                const statusSpan = document.getElementById('currentBankStatus');
                if(statusSpan) {
                    statusSpan.textContent = label;
                    statusSpan.style.color = color;
                }
            } else {
                alert("âŒ Lá»—i: " + data.message);
            }
        } catch (err) {
            console.error(err);
            alert("Lá»—i káº¿t ná»‘i server");
        }
    }

    // 1. Tráº£ bÃ n (DÃ¹ng cho Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n xong)
    async function xacNhanTraBan(orderId) {
        if (!confirm("KhÃ¡ch Ä‘Ã£ vá»? XÃ¡c nháº­n lÃ m trá»‘ng bÃ n nÃ y?")) return;
        try {
            const token = userInfo?.token;
            const res = await fetch(`/api/donhang/${orderId}/finish`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await res.json();
            if (res.ok) {
                showToast("âœ… ÄÃ£ tráº£ bÃ n thÃ nh cÃ´ng!");
                loadOrders(); // Load láº¡i báº£ng
            } else {
                alert(data.message);
            }
        } catch (e) { console.error(e); alert("Lá»—i server"); }
    }

    // 2. Há»§y Ä‘Æ¡n (DÃ¹ng cho Ä‘Æ¡n sai/test)
    async function huyDonHang(orderId) {
        if (!confirm("Báº¡n cháº¯c cháº¯n muá»‘n há»§y Ä‘Æ¡n nÃ y?")) return;
        try {
            const token = userInfo?.token;
            const res = await fetch(`/api/donhang/${orderId}`, {
                method: 'DELETE', // Hoáº·c PUT status='ÄÃ£ há»§y' tÃ¹y API cá»§a báº¡n
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                showToast("ÄÃ£ há»§y Ä‘Æ¡n hÃ ng.");
                loadOrders();
            } else {
                alert("Lá»—i khi há»§y Ä‘Æ¡n");
            }
        } catch (e) { console.error(e); }
    }

    // 3. Cáº­p nháº­t tráº¡ng thÃ¡i (Báº¯t Ä‘áº§u lÃ m)
    async function capNhatTrangThai(orderId, status) {
        try {
            const token = userInfo?.token;
            const res = await fetch(`/api/donhang/status/${orderId}`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status })
            });
            if (res.ok) loadOrders();
        } catch (e) { console.error(e); }
    }

    // 4. Thu tiá»n máº·t
    async function thanhToanTienMat(orderId) {
        if (!confirm("XÃ¡c nháº­n Ä‘Ã£ thu Ä‘á»§ tiá»n máº·t?")) return;
        try {
            const token = userInfo?.token;
            const res = await fetch(`/api/donhang/mark-paid/${orderId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                showToast("âœ… ÄÃ£ xÃ¡c nháº­n thanh toÃ¡n!");
                loadOrders();
            }
        } catch (e) { console.error(e); }
    }

// === HÃ€M Táº¢I Dá»® LIá»†U ÄÆ N HÃ€NG (ÄÃƒ FIX Lá»–I) ===
    async function loadOrders() {
         const tableBody = document.getElementById("orderTableBody"); // Äáº£m báº£o láº¥y Ä‘Ãºng element
         if (!tableBody) return;

         tableBody.innerHTML = "<tr><td colspan='9' style='text-align: center;'>â³ Äang táº£i dá»¯ liá»‡u...</td></tr>";
         
         const token = userInfo?.token; 
         if (!token) return; 

         try {
             const res = await fetch(`${window.location.origin}/api/donhang`, { 
                 headers: { Authorization: `Bearer ${token}` } 
             });
             
             if (!res.ok) { 
                 throw new Error("Lá»—i táº£i Ä‘Æ¡n hÃ ng"); 
             }
             
             const orders = await res.json();
             
             if (!Array.isArray(orders) || orders.length === 0) {
                 tableBody.innerHTML = "<tr><td colspan='9' style='text-align: center;'>KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o.</td></tr>";
                 return;
             }
             
             // Sáº¯p xáº¿p Ä‘Æ¡n má»›i lÃªn Ä‘áº§u
             orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
             
             // XÃ³a ná»™i dung cÅ©
             tableBody.innerHTML = "";

             // Render tá»«ng dÃ²ng
             orders.forEach((order) => {
                 const row = tableBody.insertRow();
                 
                 // 1. Thá»i gian
                 const time = new Date(order.createdAt).toLocaleString("vi-VN", {
                     day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                 });
                 row.insertCell().textContent = time;
                 
                 // 2. BÃ n
                 row.insertCell().textContent = order.banId?.soBan || "Mang vá»";
                 
                 // 3. TÃªn khÃ¡ch
                 row.insertCell().textContent = order.customerName || "-";
                 
                 // 4. MÃ³n Äƒn
                 const itemsCell = row.insertCell();
                 itemsCell.style.minWidth = '200px';
                 if (order.items && order.items.length > 0) { 
                     itemsCell.innerHTML = order.items.map(i => 
                        `<div>- ${i.itemId ? (i.itemId.name || '?') : '?'} (x${i.quantity})</div>`
                     ).join(''); 
                 } else { 
                     itemsCell.textContent = '-'; 
                 }
                 
                 // 5. Ghi chÃº
                 row.insertCell().textContent = order.notes || "-";
                 
                 // 6. Tá»•ng tiá»n
                 const totalCell = row.insertCell();
                 totalCell.textContent = (order.totalPrice || 0).toLocaleString('vi-VN') + 'Ä‘';
                 totalCell.style.textAlign = 'right';
                 totalCell.style.fontWeight = 'bold';
                 
                 // 7. Thanh toÃ¡n (Trang thÃ¡i tiá»n)
                 const paymentCell = row.insertCell();
                 // Kiá»ƒm tra ká»¹ cÃ¡c trÆ°á»ng (Æ°u tiÃªn trÆ°á»ng má»›i)
                 const daTra = order.amountPaid || 0;
                 const tongTien = order.totalPrice || 0;
                 let isPaid = (order.trangThaiThanhToan === 'ÄÃ£ thanh toÃ¡n') || (daTra >= tongTien && tongTien > 0);

                 if(isPaid) {
                    paymentCell.textContent = 'ÄÃ£ thanh toÃ¡n';
                    paymentCell.style.color = 'green';
                    paymentCell.style.fontWeight = 'bold';
                 } else {
                    paymentCell.textContent = 'ChÆ°a thanh toÃ¡n';
                    paymentCell.style.color = 'orange';
                 }
                 paymentCell.style.textAlign = 'center';
                 
                 // 8. Tráº¡ng thÃ¡i ÄÆ¡n (Báº¿p)
                 row.insertCell().textContent = order.status || "-";

                 // 9. HÃ€NH Äá»˜NG (NÃºt báº¥m)
                 const actionCell = row.insertCell();
                 actionCell.className = "actions-cell";
                 let btnHtml = '';

                 // Náº¿u Ä‘Ã£ thanh toÃ¡n xong -> Hiá»‡n nÃºt TRáº¢ BÃ€N
                 if (isPaid) {
                     btnHtml = `
                        <button onclick="xacNhanTraBan('${order._id}')" class="btn-action btn-complete" title="KhÃ¡ch vá», dá»n bÃ n">
                            ğŸ‘‹ Tráº£ bÃ n
                        </button>
                     `;
                 } 
                 // Náº¿u chÆ°a xong -> Hiá»‡n cÃ¡c nÃºt xá»­ lÃ½
                 else {
                     if (order.status === 'Má»›i') {
                         btnHtml += `<button onclick="capNhatTrangThai('${order._id}', 'Äang xá»­ lÃ½')" class="btn-action btn-process">ğŸ‘¨â€ğŸ³ Báº¯t Ä‘áº§u</button> `;
                     }
                     btnHtml += `<button onclick="thanhToanTienMat('${order._id}')" class="btn-action btn-process" style="background:#17a2b8;">ğŸ’µ Thu tiá»n</button> `;
                     btnHtml += `<button onclick="huyDonHang('${order._id}')" class="btn-action btn-cancel">âŒ Há»§y</button>`;
                 }
                 actionCell.innerHTML = btnHtml;
             });

         } catch (err) {
             console.error("Lá»—i khi táº£i Ä‘Æ¡n hÃ ng:", err);
             tableBody.innerHTML = `<tr><td colspan='9' style='color:red; text-align: center;'>Lá»–I: ${err.message}</td></tr>`;
         }
    }
Â  Â  Â  Â  // === HÃ€M LOGIC CHÃNH (ÄÃƒ Dá»ŒN Dáº¸P Lá»–I SOCKET) ===
Â  Â  Â  Â  function runPageLogic() {
Â  Â  Â  Â  Â  Â  tableBody = document.getElementById("orderTableBody");

Â  Â  Â  Â  Â  Â  // --- KIá»‚M TRA ÄÄ‚NG NHáº¬P & QUYá»€N ADMIN (GIá»® NGUYÃŠN) ---
Â  Â  Â  Â  Â  Â  userInfo = JSON.parse(localStorage.getItem("userInfo"));
Â  Â  Â  Â  Â  Â  if (!userInfo || userInfo.role !== "admin") {
Â  Â  Â  Â  Â  Â  Â  Â  alert(userInfo ? "Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p!" : "Vui lÃ²ng Ä‘Äƒng nháº­p!");
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = userInfo ? "/index.html" : "/login.html";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- LOGIC HEADER (GIá»® NGUYÃŠN) ---
Â  Â  Â  Â  Â  Â  const authButton = document.getElementById("authButton");
Â  Â  Â  Â  Â  Â  const navOrderLink = document.getElementById("nav-order-link");
Â  Â  Â  Â  Â  Â  const navAdminLink = document.getElementById("nav-admin-link");
Â  Â  Â  Â  Â  Â  const utilityDropdown = document.getElementById("utilityDropdown");

Â  Â  Â  Â  Â  Â  if (userInfo) { 
Â  Â  Â  Â  Â  Â  Â  Â  authButton.textContent = `ÄÄƒng xuáº¥t (${userInfo.username})`;
Â  Â  Â  Â  Â  Â  Â  Â  authButton.style.width = 'auto'; 
Â  Â  Â  Â  Â  Â  Â  Â  authButton.style.padding = '8px 16px';
Â  Â  Â  Â  Â  Â  Â  Â  if(utilityDropdown) utilityDropdown.style.display = "inline-block";
Â  Â  Â  Â  Â  Â  Â  Â  if(navOrderLink) navOrderLink.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  if(navAdminLink) navAdminLink.style.display = "inline-block";
Â  Â  Â  Â  Â  Â  Â  Â  authButton.addEventListener("click", () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.removeItem("userInfo");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem("clientCart"); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "/index.html";
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- LOGIC SOCKET CHO ÄÆ N HÃ€NG (Sá»¬ Dá»¤NG CHATBOX SOCKET) ---
Â  Â  Â  Â  Â  Â  // CÆ¡ cháº¿ kiá»ƒm tra liÃªn tá»¥c cho Ä‘áº¿n khi socket sáºµn sÃ ng
Â  Â  Â  Â  Â  Â  function setupOrderSocket() {
Â  Â  Â  Â  Â  Â  Â  Â  const socket = window.chatSocket; // Láº¥y socket Ä‘Æ°á»£c táº¡o tá»« chatbox.js

Â  Â  Â  Â  Â  Â  Â  Â  if (socket && socket.connected) {
                    console.log("admin.html: ÄÃ£ tÃ¬m tháº¥y socket, Ä‘ang láº¯ng nghe Ä‘Æ¡n hÃ ng.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.on('new_order', (newOrder) => { console.log('Admin nháº­n Ä‘Æ¡n má»›i:', newOrder); loadOrders(); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.on('order_updated', (updatedOrder) => { console.log('Admin nháº­n cáº­p nháº­t Ä‘Æ¡n:', updatedOrder); loadOrders(); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.on('order_deleted', (data) => { console.log('Admin nháº­n thÃ´ng bÃ¡o xÃ³a Ä‘Æ¡n:', data.orderId); loadOrders(); });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
                    // Náº¿u chÆ°a, thá»­ láº¡i sau 200ms
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(setupOrderSocket, 200);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
            setupOrderSocket(); // Báº¯t Ä‘áº§u láº¯ng nghe
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  loadOrders(); // Táº£i Ä‘Æ¡n hÃ ng láº§n Ä‘áº§u
Â  Â  Â  Â  }

Â  Â  Â  Â  // === CÃC CODE KHá»I Äá»˜NG (GIá»® NGUYÃŠN) ===
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  userInfo = JSON.parse(localStorage.getItem("userInfo"));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let navbarFile = '/user-navbar.html';
Â  Â  Â  Â  Â  Â  if (userInfo && userInfo.role === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  navbarFile = '/admin-navbar.html';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  fetch(navbarFile)
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`KhÃ´ng tÃ¬m tháº¥y file ${navbarFile}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return response.text();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const navbarPlaceholder = document.getElementById('navbar-placeholder');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (navbarPlaceholder) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navbarPlaceholder.innerHTML = data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("KhÃ´ng tÃ¬m tháº¥y tháº» #navbar-placeholder!");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof runPageLogic === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  runPageLogic(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("KhÃ´ng tÃ¬m tháº¥y hÃ m runPageLogic()!");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Lá»—i táº£i menu:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const navbarPlaceholder = document.getElementById('navbar-placeholder');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (navbarPlaceholder) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â navbarPlaceholder.innerHTML = `<p style="color:red; text-align:center;">Lá»–I Táº¢I MENU (${error.message})</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
async function loadBankStatus() {
        try {
            const token = userInfo?.token;
            const res = await fetch('/api/payment/current-bank', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            if (data.success) {
                const type = data.currentKey; // 'MAIN' hoáº·c 'BACKUP'
                const label = type === 'MAIN' ? 'MB Bank (ChÃ­nh)' : 'BIDV (Dá»± phÃ²ng)';
                const color = type === 'MAIN' ? 'green' : '#e65100'; // Cam Ä‘áº­m cho BIDV
                
                // Cáº­p nháº­t giao diá»‡n
                const statusSpan = document.getElementById('currentBankStatus');
                if(statusSpan) {
                    statusSpan.textContent = label;
                    statusSpan.style.color = color;
                }
            }
        } catch (e) { console.error("Lá»—i láº¥y tráº¡ng thÃ¡i NH:", e); }
    }
    // ğŸ‘†ğŸ‘†ğŸ‘† -------------------- ğŸ‘†ğŸ‘†ğŸ‘†

    // ... trong hÃ m runPageLogic() hoáº·c DOMContentLoaded ...
    function runPageLogic() {
        // ... code cÅ© ...
        loadOrders(); 
        
        loadBankStatus(); // <--- Gá»ŒI HÃ€M NÃ€Y Äá»‚ KHI F5 NÃ“ Tá»° Cáº¬P NHáº¬T Láº I
    }
Â  Â  </script>

Â  Â  Â  Â <script src="/js/script.js"></script> 

<script src="/js/aiChat.js"></script>

</body>
</html>