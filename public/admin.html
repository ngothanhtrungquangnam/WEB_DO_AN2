<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</title>
    <link rel="stylesheet" href="style.css" />
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        .actions-cell { white-space: nowrap; text-align: center; }
        .btn-action { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin: 2px; color: white; transition: opacity 0.2s ease; }
        .btn-action:hover { opacity: 0.85; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-process { background-color: #007bff; }
        .btn-complete { background-color: #28a745; }
        .btn-cancel { background-color: #dc3545; }
        .admin-page { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
        .admin-page h2 { text-align: center; color: #333; margin-bottom: 2rem; font-weight: 600; }
        .admin-page table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        .admin-page thead th { background-color: #f8f9fa; padding: 12px 10px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
        .admin-page tbody td { padding: 10px 10px; border-bottom: 1px solid #eee; vertical-align: top; color: #555; line-height: 1.5; }
        .admin-page th:nth-child(2), .admin-page td:nth-child(2),
        .admin-page th:nth-child(7), .admin-page td:nth-child(7),
        .admin-page th:nth-child(8), .admin-page td:nth-child(8),
        .admin-page th:nth-child(9), .admin-page td:nth-child(9) { text-align: center; vertical-align: middle; }
        .admin-page th:nth-child(6), .admin-page td:nth-child(6) { text-align: right; font-weight: 500; white-space: nowrap; }
        .admin-page td:nth-child(4) div { margin-bottom: 3px; }
        .admin-page tbody tr:last-child td { border-bottom: none; }
        .admin-page tbody tr:hover { background-color: #f1f1f1; }
        
        /* Cáº§n thÃªm CSS cho Tráº¡ng thÃ¡i thanh toÃ¡n Ä‘á»ƒ Ä‘áº¹p hÆ¡n (TÃ´i sáº½ giá»¯ mÃ u cÅ© cá»§a báº¡n) */
    </style>
    
    <script>
    function showSection(id) {
        document.querySelectorAll('#history, #payment, #profile').forEach(sec => sec.style.display = 'none');
        const activeSection = document.getElementById(id);
        if (activeSection) {
            activeSection.style.display = 'block';
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    </script>
</head>

<body>
    <div id="navbar-placeholder"></div>

    <main class="admin-page">
        <h2>ğŸ“‹ Danh sÃ¡ch Ä‘Æ¡n hÃ ng</h2>
        <table>
            <thead>
                <tr>
                    <th>Thá»i gian</th> <th>BÃ n sá»‘</th> <th>TÃªn khÃ¡ch</th> <th>MÃ³n Äƒn (SL)</th> <th>Ghi chÃº</th> <th>Tá»•ng tiá»n</th> <th>Thanh toÃ¡n</th> <th>Tráº¡ng thÃ¡i</th> </tr>
            </thead>
            <tbody id="orderTableBody">
                <tr><td colspan="8" style="text-align: center;">Äang táº£i dá»¯ liá»‡u...</td></tr>
            </tbody>
        </table>
    </main>

    <footer>Â© 2025 QuÃ¡n Ä‚n Ngon 24h</footer>

   <script>
Â  Â  // === BIáº¾N GLOBAL ===
Â  Â  let userInfo = null;
Â  Â  let tableBody = null; 
Â  Â  // Biáº¿n currentTargetSocketId khÃ´ng cáº§n á»Ÿ Ä‘Ã¢y ná»¯a, chatbox.js tá»± giá»¯.

Â  Â  // === CÃC HÃ€M Xá»¬ LÃ NÃšT (GIá»® NGUYÃŠN) ===
Â  Â  function showToast(message) {
Â  Â  Â  Â  if (typeof globalShowToast === 'function') { globalShowToast(message); }
Â  Â  Â  Â  else { alert(message); }
Â  Â  }

Â  Â  // === HÃ€M Táº¢I Dá»® LIá»†U CHÃNH (GIá»® NGUYÃŠN) ===
Â  Â  async function loadOrders() {
Â  Â  Â  Â  Â tableBody.innerHTML = "<tr><td colspan='8' style='text-align: center;'>Äang táº£i...</td></tr>";
Â  Â  Â  Â  Â const token = userInfo?.token; 
Â  Â  Â  Â  Â if (!token) return; 
Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â const res = await fetch(`${window.location.origin}/api/donhang`, { headers: { Authorization: `Bearer ${token}` }, });
Â  Â  Â  Â  Â  Â  Â if (!res.ok) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â const errorText = await res.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â if (errorText.includes('API Endpoint')) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tableBody.innerHTML = `<tr><td colspan='8' style='color:red; text-align: center;'>${errorText}</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â const d = JSON.parse(errorText);
Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(d.message || "Lá»—i táº£i Ä‘Æ¡n"); 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â const orders = await res.json();
Â  Â  Â  Â  Â  Â  Â if (!Array.isArray(orders)) throw new Error("Lá»—i dá»¯ liá»‡u server!");
Â  Â  Â  Â  Â  Â  Â tableBody.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â if (orders.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â tableBody.innerHTML = "<tr><td colspan='8' style='text-align: center;'>ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o.</td></tr>";
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â orders.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const statusOrder = { 'Má»›i': 0, 'Äang xá»­ lÃ½': 1, 'HoÃ n thÃ nh': 2, 'ÄÃ£ há»§y': 3 };
Â  Â  Â  Â  Â  Â  Â  Â  Â const statusA = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 99;
Â  Â  Â  Â  Â  Â  Â  Â  Â const statusB = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 99;
Â  Â  Â  Â  Â  Â  Â  Â  Â if (statusA !== statusB) return statusA - statusB;
Â  Â  Â  Â  Â  Â  Â  Â  Â return new Date(b.createdAt) - new Date(a.createdAt);
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â orders.forEach((order) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const row = tableBody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  Â const time = new Date(order.createdAt).toLocaleString("vi-VN",{ day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
Â  Â  Â  Â  Â  Â  Â  Â  Â row.insertCell().textContent = time;
Â  Â  Â  Â  Â  Â  Â  Â  Â row.insertCell().textContent = order.banId?.soBan || "-";
Â  Â  Â  Â  Â  Â  Â  Â  Â row.insertCell().textContent = order.customerName || "-";
Â  Â  Â  Â  Â  Â  Â  Â  Â const itemsCell = row.insertCell();
Â  Â  Â  Â  Â  Â  Â  Â  Â itemsCell.style.minWidth = '200px';
Â  Â  Â  Â  Â  Â  Â  Â  Â if (order.items && order.items.length > 0) { itemsCell.innerHTML = order.items.map(i => `<div>- ${i.itemId ? (i.itemId.name || '?') : '?'} (x${i.quantity})</div>`).join(''); }
Â  Â  Â  Â  Â  Â  Â  Â  Â else { itemsCell.textContent = '-'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â row.insertCell().textContent = order.notes || "-";
Â  Â  Â  Â  Â  Â  Â  Â  Â const totalCell = row.insertCell();
Â  Â  Â  Â  Â  Â  Â  Â  Â totalCell.textContent = (typeof order.totalPrice === 'number') ? order.totalPrice.toLocaleString('vi-VN') + 'Ä‘' : '-';
Â  Â  Â  Â  Â  Â  Â  Â  Â totalCell.style.textAlign = 'right';
Â  Â  Â  Â  Â  Â  Â  Â  Â const paymentCell = row.insertCell();
Â  Â  Â  Â  Â  Â  Â  Â  Â paymentCell.textContent = order.trangThaiThanhToan || 'ChÆ°a thanh toÃ¡n';
Â  Â  Â  Â  Â  Â  Â  Â  Â if(order.trangThaiThanhToan === 'ÄÃ£ thanh toÃ¡n') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentCell.style.color = 'green';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentCell.style.fontWeight = 'bold';
Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentCell.style.color = 'orange';
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â paymentCell.style.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  Â row.insertCell().textContent = order.status || "-";
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Lá»—i khi táº£i Ä‘Æ¡n hÃ ng:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â tableBody.innerHTML = `<tr><td colspan='8' style='color:red; text-align: center;'>Lá»–I Táº¢I Dá»® LIá»†U: ${err.message}</td></tr>`;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // === HÃ€M LOGIC CHÃNH (ÄÃƒ Dá»ŒN Dáº¸P Lá»–I SOCKET) ===
Â  Â  Â  Â  function runPageLogic() {
Â  Â  Â  Â  Â  Â  tableBody = document.getElementById("orderTableBody");

Â  Â  Â  Â  Â  Â  // --- KIá»‚M TRA ÄÄ‚NG NHáº¬P & QUYá»€N ADMIN (GIá»® NGUYÃŠN) ---
Â  Â  Â  Â  Â  Â  userInfo = JSON.parse(localStorage.getItem("userInfo"));
Â  Â  Â  Â  Â  Â  if (!userInfo || userInfo.role !== "admin") {
Â  Â  Â  Â  Â  Â  Â  Â  alert(userInfo ? "Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p!" : "Vui lÃ²ng Ä‘Äƒng nháº­p!");
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = userInfo ? "/index.html" : "/login.html";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- LOGIC HEADER (GIá»® NGUYÃŠN) ---
Â  Â  Â  Â  Â  Â  const authButton = document.getElementById("authButton");
Â  Â  Â  Â  Â  Â  const navOrderLink = document.getElementById("nav-order-link");
Â  Â  Â  Â  Â  Â  const navAdminLink = document.getElementById("nav-admin-link");
Â  Â  Â  Â  Â  Â  const utilityDropdown = document.getElementById("utilityDropdown");

Â  Â  Â  Â  Â  Â  if (userInfo) { 
Â  Â  Â  Â  Â  Â  Â  Â  authButton.textContent = `ÄÄƒng xuáº¥t (${userInfo.username})`;
Â  Â  Â  Â  Â  Â  Â  Â  authButton.style.width = 'auto'; 
Â  Â  Â  Â  Â  Â  Â  Â  authButton.style.padding = '8px 16px';
Â  Â  Â  Â  Â  Â  Â  Â  if(utilityDropdown) utilityDropdown.style.display = "inline-block";
Â  Â  Â  Â  Â  Â  Â  Â  if(navOrderLink) navOrderLink.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  if(navAdminLink) navAdminLink.style.display = "inline-block";
Â  Â  Â  Â  Â  Â  Â  Â  authButton.addEventListener("click", () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.removeItem("userInfo");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem("clientCart"); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "/index.html";
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- LOGIC SOCKET CHO ÄÆ N HÃ€NG (Sá»¬ Dá»¤NG CHATBOX SOCKET) ---
Â  Â  Â  Â  Â  Â  // CÆ¡ cháº¿ kiá»ƒm tra liÃªn tá»¥c cho Ä‘áº¿n khi socket sáºµn sÃ ng
Â  Â  Â  Â  Â  Â  function setupOrderSocket() {
Â  Â  Â  Â  Â  Â  Â  Â  const socket = window.chatSocket; // Láº¥y socket Ä‘Æ°á»£c táº¡o tá»« chatbox.js

Â  Â  Â  Â  Â  Â  Â  Â  if (socket && socket.connected) {
                    console.log("admin.html: ÄÃ£ tÃ¬m tháº¥y socket, Ä‘ang láº¯ng nghe Ä‘Æ¡n hÃ ng.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.on('new_order', (newOrder) => { console.log('Admin nháº­n Ä‘Æ¡n má»›i:', newOrder); loadOrders(); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.on('order_updated', (updatedOrder) => { console.log('Admin nháº­n cáº­p nháº­t Ä‘Æ¡n:', updatedOrder); loadOrders(); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.on('order_deleted', (data) => { console.log('Admin nháº­n thÃ´ng bÃ¡o xÃ³a Ä‘Æ¡n:', data.orderId); loadOrders(); });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
                    // Náº¿u chÆ°a, thá»­ láº¡i sau 200ms
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(setupOrderSocket, 200);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
            setupOrderSocket(); // Báº¯t Ä‘áº§u láº¯ng nghe
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  loadOrders(); // Táº£i Ä‘Æ¡n hÃ ng láº§n Ä‘áº§u
Â  Â  Â  Â  }

Â  Â  Â  Â  // === CÃC CODE KHá»I Äá»˜NG (GIá»® NGUYÃŠN) ===
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  userInfo = JSON.parse(localStorage.getItem("userInfo"));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let navbarFile = '/user-navbar.html';
Â  Â  Â  Â  Â  Â  if (userInfo && userInfo.role === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  navbarFile = '/admin-navbar.html';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  fetch(navbarFile)
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`KhÃ´ng tÃ¬m tháº¥y file ${navbarFile}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return response.text();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const navbarPlaceholder = document.getElementById('navbar-placeholder');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (navbarPlaceholder) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navbarPlaceholder.innerHTML = data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("KhÃ´ng tÃ¬m tháº¥y tháº» #navbar-placeholder!");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof runPageLogic === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  runPageLogic(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("KhÃ´ng tÃ¬m tháº¥y hÃ m runPageLogic()!");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Lá»—i táº£i menu:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const navbarPlaceholder = document.getElementById('navbar-placeholder');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (navbarPlaceholder) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â navbarPlaceholder.innerHTML = `<p style="color:red; text-align:center;">Lá»–I Táº¢I MENU (${error.message})</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  </script>

Â  Â  Â  Â  <script src="/js/chatbox.js"></script>

</body>
</html>