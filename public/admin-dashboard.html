<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Qu·∫£n L√Ω Nh√† H√†ng</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; }
        .admin-dashboard-container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        /* Ti√™u ƒë·ªÅ */
        .welcome-section { margin-bottom: 2rem; }
        .welcome-section h1 { font-size: 1.8rem; color: #333; margin: 0; }
        .welcome-section p { color: #666; margin-top: 5px; }

        /* 1. KHU V·ª∞C TH·ªêNG K√ä (S·ªê LI·ªÜU) */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #ddd; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card h3 { margin: 0 0 10px 0; color: #888; font-size: 0.9rem; text-transform: uppercase; font-weight: 600; }
        .stat-card .value { font-size: 1.8rem; font-weight: bold; color: #333; }
        
        .border-blue { border-left-color: #007bff; }
        .border-green { border-left-color: #28a745; }
        .border-orange { border-left-color: #fd7e14; }
        .border-purple { border-left-color: #6f42c1; }

        /* 2. KHU V·ª∞C BI·ªÇU ƒê·ªí */
        .charts-section { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 3rem; }
        .chart-box { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem; color: #444; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* 3. KHU V·ª∞C ƒêI·ªÄU H∆Ø·ªöNG (NAVIGATE) */
        .quick-actions h2 { font-size: 1.3rem; color: #333; margin-bottom: 1rem; border-left: 4px solid #ff7043; padding-left: 10px; }
        .dashboard-links { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .dashboard-card { 
            display: block; padding: 1.5rem; background: white; 
            border: 1px solid #eee; border-radius: 12px; text-decoration: none; color: inherit; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; 
        }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: #ff7043; }
        .dashboard-card h3 { color: #ff7043; margin: 0 0 5px 0; font-size: 1.2rem; }
        .dashboard-card p { color: #666; font-size: 0.95rem; margin: 0; }

        @media (max-width: 900px) { .charts-section { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="navbar-placeholder"></div>

    <main class="admin-dashboard-container">
        
        <div class="welcome-section" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <div>
        <h1>üëã Xin ch√†o, Admin!</h1>
        <p>ƒê√¢y l√† t√¨nh h√¨nh kinh doanh c·ªßa nh√† h√†ng.</p>
    </div>
    
    <div class="date-filter" style="display: flex; gap: 10px; align-items: center;">
        <label for="statsDate" style="font-weight: bold; color: #555;">Ch·ªçn ng√†y:</label>
        <input type="date" id="statsDate" style="padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem;">
        <button onclick="loadRealStats()" style="padding: 8px 15px; background-color: #ff7043; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
            Xem b√°o c√°o
        </button>
    </div>
</div>

        <div class="stats-grid">
            <div class="stat-card border-blue">
                <h3>T·ªïng Doanh Thu</h3>
                <div class="value">15.500.000ƒë</div>
            </div>
            <div class="stat-card border-green">
                <h3>ƒê∆°n H√†ng</h3>
                <div class="value">45 ƒê∆°n</div>
            </div>
            <div class="stat-card border-orange">
                <h3>Ti·ªÅn M·∫∑t</h3>
                <div class="value">5.500.000ƒë</div>
            </div>
            <div class="stat-card border-purple">
                <h3>Chuy·ªÉn Kho·∫£n</h3>
                <div class="value">10.000.000ƒë</div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-box">
                <div class="chart-title">üìà Doanh thu theo gi·ªù</div>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">üí≥ T·ª∑ l·ªá thanh to√°n</div>
                <canvas id="paymentChart"></canvas>
            </div>
        </div>

        <div class="quick-actions">
            <h2>üöÄ Truy c·∫≠p nhanh</h2>
            <div class="dashboard-links">
                <a href="/admin-donhang.html" class="dashboard-card">
                    <h3>üìã Qu·∫£n l√Ω ƒê∆°n h√†ng</h3>
                    <p>Xem danh s√°ch ƒë∆°n, l·ªçc theo ng√†y v√† tr·∫°ng th√°i.</p>
                </a>
                <a href="/admin-ban.html" class="dashboard-card">
                    <h3>üçΩÔ∏è S∆° ƒë·ªì B√†n ƒÉn</h3>
                    <p>Qu·∫£n l√Ω tr·∫°ng th√°i b√†n, x·∫øp ch·ªó v√† thanh to√°n t·∫°i b√†n.</p>
                </a>
                <a href="/quan-ly-mon-an.html" class="dashboard-card">
                    <h3>üç¥ Qu·∫£n l√Ω M√≥n ƒÉn</h3>
                    <p>Th√™m m√≥n m·ªõi, s·ª≠a gi√° v√† c·∫≠p nh·∫≠t th·ª±c ƒë∆°n.</p>
                </a>
            </div>
        </div>

    </main>

  <script>
        let userInfo = null; // Khai b√°o bi·∫øn to√†n c·ª•c ƒë·ªÉ d√πng l·∫°i

        document.addEventListener("DOMContentLoaded", () => {
            userInfo = JSON.parse(localStorage.getItem("userInfo"));
            
            // 1. Ki·ªÉm tra quy·ªÅn Admin
            if (!userInfo || userInfo.role !== 'admin') {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.');
                window.location.href = '/login.html';
                return;
            }

            // 2. T·∫£i Navbar
            fetch('/admin-navbar.html')
                .then(r => r.text())
                .then(data => {
                    document.getElementById('navbar-placeholder').innerHTML = data;
                    // X·ª≠ l√Ω n√∫t ƒëƒÉng xu·∫•t (n·∫øu navbar ch∆∞a t·ª± x·ª≠ l√Ω)
                    const authButton = document.getElementById('authButton');
                    if (authButton) {
                        authButton.textContent = `ƒêƒÉng xu·∫•t (${userInfo.username})`;
                        authButton.addEventListener('click', () => {
                            localStorage.clear();
                            window.location.href = '/index.html';
                        });
                    }
                });
         // 3. ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho √¥ ng√†y l√† "H√¥m nay"
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('statsDate').value = today;    

            // 4. G·ªåI H√ÄM L·∫§Y S·ªê LI·ªÜU TH·∫¨T (Thay v√¨ v·∫Ω lu√¥n)
            loadRealStats();
        });

      async function loadRealStats() {
    try {
        // 1. L·∫•y ng√†y ng∆∞·ªùi d√πng ch·ªçn
        const dateInput = document.getElementById('statsDate').value;
        
        // 2. T·∫°o URL c√≥ ch·ª©a tham s·ªë ng√†y (Query Param)
        let url = '/api/donhang/stats/daily';
        if (dateInput) {
            url += `?date=${dateInput}`;
        }

        // 3. G·ªçi API
        const res = await fetch(url, {
            headers: { 'Authorization': `Bearer ${userInfo.token}` }
        });
        const result = await res.json();

        if (!result.success) throw new Error(result.message || 'L·ªói t·∫£i th·ªëng k√™');
        
        const data = result.data;

        // ... (Ph·∫ßn hi·ªÉn th·ªã s·ªë li·ªáu v√† v·∫Ω bi·ªÉu ƒë·ªì GI·ªÆ NGUY√äN kh√¥ng ƒë·ªïi) ...
        document.querySelector('.stat-card.border-blue .value').innerText = (data.totalRevenue || 0).toLocaleString('vi-VN') + 'ƒë';
        document.querySelector('.stat-card.border-green .value').innerText = (data.totalOrders || 0) + ' ƒê∆°n';
        document.querySelector('.stat-card.border-orange .value').innerText = (data.cashRevenue || 0).toLocaleString('vi-VN') + 'ƒë';
        document.querySelector('.stat-card.border-purple .value').innerText = (data.onlineRevenue || 0).toLocaleString('vi-VN') + 'ƒë';

        // G·ªçi h√†m v·∫Ω (N·∫øu bi·ªÉu ƒë·ªì ƒë√£ c√≥ th√¨ destroy ƒëi v·∫Ω l·∫°i ƒë·ªÉ tr√°nh b·ªã ch·ªìng h√¨nh)
        renderRealCharts(data);

    } catch (err) {
        console.error("L·ªói th·ªëng k√™:", err);
        alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: " + err.message);
    }
}

// L∆∞u √Ω: B·∫°n c·∫ßn s·ª≠a nh·∫π h√†m renderRealCharts ƒë·ªÉ h·ªßy bi·ªÉu ƒë·ªì c≈© tr∆∞·ªõc khi v·∫Ω m·ªõi
let revenueChartInstance = null;
let paymentChartInstance = null;

function renderRealCharts(data) {
    const ctxLine = document.getElementById('revenueChart').getContext('2d');
    const ctxPie = document.getElementById('paymentChart').getContext('2d');

    // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu t·ªìn t·∫°i (ƒë·ªÉ khi ch·ªçn ng√†y kh√°c n√≥ v·∫Ω l·∫°i)
    if (revenueChartInstance) revenueChartInstance.destroy();
    if (paymentChartInstance) paymentChartInstance.destroy();

    // V·∫Ω bi·ªÉu ƒë·ªì ƒë∆∞·ªùng
    revenueChartInstance = new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}h`),
            datasets: [{
                label: 'Doanh thu (VNƒê)',
                data: data.hourlyRevenue,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // V·∫Ω bi·ªÉu ƒë·ªì tr√≤n
    paymentChartInstance = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['Ti·ªÅn m·∫∑t', 'Chuy·ªÉn kho·∫£n'],
            datasets: [{
                data: [data.cashRevenue, data.onlineRevenue],
                backgroundColor: ['#fd7e14', '#6f42c1']
            }]
        }
    });
}
    </script>
</body>
</html>