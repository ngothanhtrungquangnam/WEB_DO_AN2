<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B√†n - Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* (To√†n b·ªô CSS c·ªßa b·∫°n gi·ªØ nguy√™n... ) */
        body { background-color: #f4f4f4; margin: 0; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
        .admin-header {
            text-align: center; color: #333; font-size: 2rem;
            margin-bottom: 2rem; display: flex; align-items: center;
            justify-content: center; gap: 10px;
        }
        .legend { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1.5rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #ccc; }
        .legend-trong { background-color: #e8f5e9; border-color: #4caf50; }
        .legend-daphucvu { background-color: #fff3e0; border-color: #ff9800; }
        .table-map {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 1.2rem;
            background: #fff;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .table-item {
            border: 2px solid; border-radius: 8px; padding: 2rem 0.5rem;
            text-align: center; font-weight: bold; font-size: 1.1rem;
            cursor: pointer; transition: all 0.2s ease; position: relative;
        }
        .table-item.status-trong {
            border-color: #66bb6a; color: #388e3c; background: #e8f5e9;
        }
        .table-item.status-trong:hover {
            background: #c8e6c9; transform: scale(1.05);
        }
        .table-item.status-dang-phuc-vu {
            border-color: #ffa726; color: #f57c00; background: #fff3e0;
        }
        .table-item.status-dang-phuc-vu:hover {
            background: #ffe0b2; transform: scale(1.05);
        }
        .table-item .order-total {
            position: absolute; bottom: 8px; left: 0; width: 100%;
            font-size: 0.9rem; color: #d84315; font-weight: bold;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; border-radius: 10px; padding: 0;
            width: 90%; max-width: 500px;
            max-height: 90vh; 
            display: flex; flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 1rem 1.5rem; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .modal-header h3 { margin: 0; color: var(--main-color, #ff7043); }
        .modal-close { font-size: 2rem; font-weight: bold; cursor: pointer; color: #888; }
        .modal-body { 
            padding: 1.5rem; 
            overflow-y: auto;
        }
        .modal-body .info-group { margin-bottom: 1rem; }
        .modal-body .info-group strong { color: #333; }
        .modal-body .info-group p { margin: 4px 0; color: #555; }
        .modal-items { border-top: 1px dashed #ddd; border-bottom: 1px dashed #ddd; padding: 1rem 0; }
        .modal-item { display: flex; justify-content: space-between; font-size: 0.95rem; margin-bottom: 5px; }
        .modal-total { text-align: right; font-size: 1.3rem; font-weight: bold; margin: 1rem 0; }
        .modal-actions { 
            text-align: center; padding: 0 1.5rem 1.5rem; 
            flex-shrink: 0;
        }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-weight: 500; font-size: 0.8rem; display: inline-block; }
        .status-moi { background-color: #e0f7fa; color: #007bff; }
        .status-dang-xu-ly { background-color: #fffde7; color: #f59e0b; }
        .status-hoan-thanh { background-color: #e8f5e9; color: #4caf50; }
        .payment-paid { color: #4caf50; font-weight: bold; }
        .payment-unpaid { color: #f59e0b; font-weight: bold; }
        .action-buttons button {
            border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;
            font-size: 0.9rem; font-weight: 500; margin: 5px;
            transition: opacity 0.2s;
        }
        .action-buttons button:hover { opacity: 0.8; }
        .btn-processing { background-color: #007bff; color: white; }
        .btn-complete { background-color: #28a745; color: white; }
        .btn-cancel { background-color: #dc3545; color: white; }
        .btn-delete { background-color: #6c757d; color: white; }
        .btn-mark-paid { background-color: #17a2b8; color: white; }
        .btn-release-table { background-color: #ffc107; color: #333; }
    </style>
</head>
<body>

    <div id="navbar-placeholder"></div>

    <main class="container">
        <h2 class="admin-header">S∆° ƒë·ªì Qu·∫£n l√Ω b√†n</h2>
        
        <div class="legend">
            <div class="legend-item"><div class="legend-color legend-trong"></div><span>Tr·ªëng</span></div>
            <div class="legend-item"><div class="legend-color legend-daphucvu"></div><span>ƒêang ph·ª•c v·ª•</span></div>
        </div>

        <div id="tableMapContainer" class="table-map">
            <p style="grid-column: 1 / -1; text-align: center; color: #888;">ƒêang t·∫£i s∆° ƒë·ªì b√†n...</p>
        </div>
    </main>

    <div id="orderDetailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chi ti·∫øt ƒë∆°n h√†ng</h3>
                <span class="modal-close" id="closeModalBtn">&times;</span>
            </div>
            <div class="modal-body" id="modalBodyContent">
                </div>
        </div>
    </div>
    
    <footer style="text-align: center; padding: 20px; margin-top: 20px;">
        <p>¬© 2025 Qu√°n ƒÇn Ngon 24h</p>
    </footer>

    <script>
        let userInfo = null;
        let socket = null;
        
        // === C√ÅC H√ÄM X·ª¨ L√ù API (G·ªåI KHI B·∫§M N√öT TRONG MODAL) ===
        // (Gi·ªØ nguy√™n c√°c h√†m: handleUpdateStatus, handleDeleteOrder, handleMarkAsPaid, handleReleaseTable)
        async function handleUpdateStatus(orderId, newStatus) {
            if (!confirm(`C·∫≠p nh·∫≠t ƒë∆°n #${orderId.substring(0, 6)} th√†nh "${newStatus}"?`)) return;
            try {
                const response = await fetch(`/api/donhang/status/${orderId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userInfo.token}` },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!response.ok) throw new Error((await response.json()).message);
                closeModal();
            } catch (err) { alert(`L·ªói: ${err.message}`); }
        }
        async function handleDeleteOrder(orderId) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA Vƒ®NH VI·ªÑN ƒë∆°n h√†ng #${orderId.substring(0, 6)}?`)) return;
            try {
                const response = await fetch(`/api/donhang/${orderId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${userInfo.token}` }
                });
                if (!response.ok) throw new Error((await response.json()).message);
                closeModal();
            } catch (err) { alert(`L·ªói: ${err.message}`); }
        }
     async function handleMarkAsPaid(orderId) {
    if (!confirm(`X√°c nh·∫≠n ƒë√£ nh·∫≠n ƒë·ªß ti·ªÅn m·∫∑t t·ª´ kh√°ch?`)) return;
    try {
        // G·ªçi API PUT /pay m√† b·∫°n v·ª´a t·∫°o
        const response = await fetch(`/api/donhang/${orderId}/pay`, {
            method: 'PUT', // S·ª≠a th√†nh PUT
            headers: { 'Authorization': `Bearer ${userInfo.token}` } // Kh√¥ng c·∫ßn Content-Type json v√¨ kh√¥ng g·ª≠i body
        });
        
        if (!response.ok) throw new Error((await response.json()).message);
        
        // ƒê√≥ng modal c≈©
        closeModal();
        // M·∫πo: G·ªçi l·∫°i showOrderDetailModal ƒë·ªÉ m·ªü l·∫°i modal ngay l·∫≠p t·ª©c -> th·∫•y n√∫t "Tr·∫£ b√†n" hi·ªán ra lu√¥n
        // showOrderDetailModal(orderId); 
    } catch (err) { alert(`L·ªói: ${err.message}`); }
}
       async function handleReleaseTable(orderId) {
    if (!confirm(`Kh√°ch ƒë√£ v·ªÅ v√† d·ªçn b√†n xong? (B√†n s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i Tr·ªëng)`)) return;
    try {
        // G·ªçi API PUT /finish
        const response = await fetch(`/api/donhang/${orderId}/finish`, {
            method: 'PUT', // S·ª≠a th√†nh PUT
            headers: { 'Authorization': `Bearer ${userInfo.token}` }
        });
        
        if (!response.ok) throw new Error((await response.json()).message);
        
        closeModal();
        // Load l·∫°i s∆° ƒë·ªì b√†n (th·ª±c ra socket ƒë√£ t·ª± l√†m r·ªìi, nh∆∞ng g·ªçi th√™m cho ch·∫Øc)
        loadDataAndRenderMap();
    } catch (err) { alert(`L·ªói: ${err.message}`); }
}
        // === C√ÅC H√ÄM HI·ªÇN TH·ªä (RENDER) ===

        // 4. T·∫£i v√† V·∫Ω S∆° ƒë·ªì b√†n (ƒê√É S·ª¨A L·ªñI LOGIC)
        async function loadDataAndRenderMap() {
            const mapContainer = document.getElementById('tableMapContainer');
            
            if (!mapContainer.querySelector('.table-item')) {
                 mapContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #888;">ƒêang t·∫£i...</p>';
            }
            
            try {
                // *** CH·ªà C·∫¶N G·ªåI 1 API ƒê·ªÇ L·∫§Y B√ÄN ***
                const banResponse = await fetch('/api/ban', { 
                    headers: { 'Authorization': `Bearer ${userInfo.token}` } 
                });

                if (!banResponse.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i s∆° ƒë·ªì b√†n');
                
                const allTables = await banResponse.json();
                
                mapContainer.innerHTML = ''; // X√≥a ch·ªØ "ƒêang t·∫£i"
                
                allTables.sort((a, b) => {
                    const numA = parseInt(a.soBan.replace('B√†n ', ''));
                    const numB = parseInt(b.soBan.replace('B√†n ', ''));
                    return numA - numB;
                });
                
                // B·∫Øt ƒë·∫ßu v·∫Ω c√°c b√†n
                allTables.forEach(ban => {
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'table-item';
                    
                    // *** D√ôNG TR·ª∞C TI·∫æP ban.trangThai ***
                    if (ban.trangThai === 'ƒêang ph·ª•c v·ª•') {
                        // B√ÄN ƒêANG PH·ª§C V·ª§
                        tableDiv.classList.add('status-dang-phuc-vu');
                        tableDiv.innerHTML = `<span>${ban.soBan}</span>`;
                        
                        if (ban.donHangHienTai) {
                            // G√°n s·ª± ki·ªán click ƒë·ªÉ m·ªü modal
                            tableDiv.addEventListener('click', () => showOrderDetailModal(ban.donHangHienTai));
                        } else {
                            // L·ªói d·ªØ li·ªáu: b√†n b·∫≠n nh∆∞ng ko c√≥ ƒë∆°n
                            tableDiv.addEventListener('click', () => alert(`L·ªói: B√†n ${ban.soBan} ƒëang ph·ª•c v·ª• nh∆∞ng kh√¥ng t√¨m th·∫•y ID ƒë∆°n h√†ng.`));
                        }
                    } else {
                        // B√ÄN TR·ªêNG
                        tableDiv.classList.add('status-trong');
                        tableDiv.innerHTML = `<span>${ban.soBan}</span>`;
                        tableDiv.addEventListener('click', () => {
                            alert(`B√†n ${ban.soBan} ƒëang tr·ªëng.`);
                        });
                    }
                    mapContainer.appendChild(tableDiv);
                });

            } catch (err) {
                console.error(err);
                mapContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: red;">${err.message}</p>`;
            }
        }
        
        // 5. Hi·ªÉn th·ªã Modal chi ti·∫øt ƒë∆°n h√†ng (ƒê√É S·ª¨A: NH·∫¨N V√ÄO ORDER ID)
        async function showOrderDetailModal(orderId) { 
            const modal = document.getElementById('orderDetailModal');
            const content = document.getElementById('modalBodyContent');
            
            modal.style.display = 'flex';
            content.innerHTML = '<p style="text-align: center; padding: 2rem; color: #888;">ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng...</p>';
            
            try {
                // === G·ªåI API ƒê·ªÇ L·∫§Y CHI TI·∫æT (POPULATE) ===
                const response = await fetch(`/api/donhang/details/${orderId}`, { // S·ª≠a: D√πng orderId
                    headers: { 'Authorization': `Bearer ${userInfo.token}` }
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
                }
                
                const order = await response.json(); // ƒê√¢y l√† ƒë∆°n h√†ng ƒë·∫ßy ƒë·ªß

                // S·ª¨A L·ªñI NaNƒë
                const itemsHtml = order.items.map(item => {
                    const itemPrice = (item.itemId && item.itemId.gia !== undefined) ? item.itemId.gia : (item.itemId ? item.itemId.price : 0);
                    const totalItemPrice = (itemPrice * item.quantity) || 0;
                    return `
                    <div class="modal-item">
                        <span>${item.itemId ? item.itemId.name : 'N/A'} (x${item.quantity})</span>
                        <span>${totalItemPrice.toLocaleString('vi-VN')}ƒë</span>
                    </div>`
                }).join('');
                
                const paymentStatus = order.trangThaiThanhToan === 'ƒê√£ thanh to√°n' 
                    ? `<span class="payment-paid">ƒê√£ thanh to√°n</span>`
                    : `<span class="payment-unpaid">${order.trangThaiThanhToan}</span>`;

                let statusClass = 'status-moi';
                if(order.status === 'ƒêang x·ª≠ l√Ω') statusClass = 'status-dang-xu-ly';
                if(order.status === 'Ho√†n th√†nh') statusClass = 'status-hoan-thanh';
                const orderStatus = `<span class="status-badge ${statusClass}">${order.status}</span>`;

                content.innerHTML = `
                    <div class="info-group">
                        <strong>B√†n:</strong> <p style="display: inline; font-weight: bold; font-size: 1.1rem;">${order.banId.soBan}</p>
                    </div>
                    <div class="info-group">
                        <strong>Kh√°ch h√†ng:</strong> <p>${order.customerName}</p>
                    </div>
                    <div class="info-group">
                        <strong>Tr·∫°ng th√°i:</strong> <p>${orderStatus} &nbsp; ${paymentStatus}</p>
                    </div>
                    
                    <div class="modal-items">${itemsHtml}</div>
                    <div class="modal-total">T·ªïng: ${(order.totalPrice || 0).toLocaleString('vi-VN')} VNƒê</div>
                    
                    <div class="modal-actions action-buttons" id="modalActionsContainer">
                    </div>
                `;
                
                const actionsContainer = content.querySelector('#modalActionsContainer');
                actionsContainer.innerHTML = renderActionButtons(order);
                attachActionEvents(order, actionsContainer);

            } catch(err) {
                content.innerHTML = `<p style="text-align: center; padding: 2rem; color: red;">${err.message}</p>`;
            }
        }
        
        // 6. ƒê√≥ng Modal
        function closeModal() {
            document.getElementById('orderDetailModal').style.display = 'none';
        }

// public/admin-ban.html

function renderActionButtons(order) {
    let buttonsHtml = '';
    
    // 1. T√çNH TO√ÅN TI·ªÄN NONG
    const tongTien = parseInt(order.totalPrice) || 0;
    let daTra = parseInt(order.amountPaid) || 0; 

    // Fix l·ªói ƒë∆°n c≈©: N·∫øu tr·∫°ng th√°i l√† "ƒê√£ thanh to√°n" m√† trong DB ghi ƒë√£ tr·∫£ = 0 -> Coi nh∆∞ ƒë√£ tr·∫£ ƒë·ªß
    if (order.trangThaiThanhToan === 'ƒê√£ thanh to√°n' && daTra === 0) {
        daTra = tongTien;
    }

    const chenhLech = tongTien - daTra; 
    const daHoanThanh = order.status === 'Ho√†n th√†nh';
    // ƒê√£ thanh to√°n xong khi: Tr·∫°ng th√°i ƒë√∫ng V√Ä Ti·ªÅn ƒë√£ ƒë·ªß (<=0)
    // L∆∞u √Ω: Tr∆∞·ªùng h·ª£p d∆∞ ti·ªÅn (chenhLech < 0) v·∫´n c·∫ßn x·ª≠ l√Ω ho√†n ti·ªÅn tr∆∞·ªõc khi cho ph√©p tr·∫£ b√†n
    const daThanhToanXong = (order.trangThaiThanhToan === 'ƒê√£ thanh to√°n' || order.trangThaiThanhToan === 'Ch·ªù ho√†n ti·ªÅn') && chenhLech <= 0;

    // 2. DEFINES STYLES
    const btnFull = 'width:100%; font-size:1.1rem; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; margin-top:5px;';
    const btnHalf = 'width:48%; font-size:1rem; padding:10px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:white; margin-top:5px;';
    const outlineGrayStyle = 'background:none; border: 1px solid #ccc; color: #777; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;';
    const statusTextStyle = 'text-align: center; margin-bottom: 12px; font-weight: 600; font-size: 1.1rem;';
    
    // N√∫t In h√≥a ƒë∆°n (Nh·ªè, x√°m nh·∫°t, n·∫±m d∆∞·ªõi)
    const btnPrintStyle = 'width:100%; padding:8px; margin-top:15px; margin-bottom:5px; border:1px solid #ccc; background:#f9f9f9; color:#555; font-weight:600; border-radius:5px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:5px; font-size:0.95rem; transition: all 0.2s;';
    const btnPrint = `<button onclick="printBill('${order._id}')" style="${btnPrintStyle}" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f9f9f9'">üñ®Ô∏è In h√≥a ƒë∆°n</button>`;

    // =========================================================
    // LOGIC HI·ªÇN TH·ªä
    // =========================================================

    // TR∆Ø·ªúNG H·ª¢P 1: ƒê∆°n M·ªöI ho·∫∑c ƒêANG X·ª¨ L√ù
    if (order.status === 'M·ªõi' || order.status === 'ƒêang x·ª≠ l√Ω') {
        
        // C√°c n√∫t t√°c v·ª• ch√≠nh (B·∫øp)
        buttonsHtml += `<div style="display:flex; justify-content:space-between;">`;
        if (order.status === 'M·ªõi') {
            buttonsHtml += `<button class="btn-processing" data-action="processing" style="${btnHalf} background:#007bff;">üë®‚Äçüç≥ B·∫Øt ƒë·∫ßu l√†m</button>`;
        } else {
            buttonsHtml += `<button class="btn-complete" data-action="complete" style="${btnHalf} background:#28a745;">‚úÖ ƒê√£ xong m√≥n</button>`;
        }
        buttonsHtml += `<button class="btn-cancel" data-action="cancel" style="${btnHalf} background:#dc3545;">‚ùå H·ªßy ƒë∆°n</button>`;
        buttonsHtml += `</div>`;

        // N√∫t In h√≥a ƒë∆°n (N·∫±m d∆∞·ªõi)
        buttonsHtml += btnPrint;
    } 
    
    // TR∆Ø·ªúNG H·ª¢P 2: ƒê∆°n ƒë√£ HO√ÄN TH√ÄNH (B·∫øp xong -> Thu ng√¢n)
    else if (daHoanThanh) {
        
        // --- ∆ØU TI√äN 1: X·ª¨ L√ù TI·ªÄN TH·ª™A (HO√ÄN TI·ªÄN) ---
        // N·∫øu ch√™nh l·ªách < 0 (Kh√°ch tr·∫£ d∆∞), B·∫ÆT BU·ªòC hi·ªán n√∫t ho√†n ti·ªÅn tr∆∞·ªõc
        if (chenhLech < 0) {
            const tienHoan = Math.abs(chenhLech);
          buttonsHtml += `
        <div style="background-color: #fff3e0; padding: 12px; border-radius: 8px; border: 1px solid #ffe0b2; margin-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; color:#555; margin-bottom: 5px;">
                <span>T·ªïng ƒë∆°n:</span> <strong>${tongTien.toLocaleString()}ƒë</strong>
            </div>
            <div style="display:flex; justify-content:space-between; color:#555; border-bottom:1px dashed #ccc; padding-bottom:8px; margin-bottom:8px;">
                <span>ƒê√£ thanh to√°n:</span> <span>-${daTra.toLocaleString()}ƒë</span>
            </div>
            <div style="display:flex; justify-content:space-between; color:#d84315; font-weight:bold; font-size:1.2rem;">
                <span>C·∫¶N HO√ÄN L·∫†I:</span> <span>${tienHoan.toLocaleString()}ƒë</span>
            </div>
        </div>

        <button onclick="handleMarkAsPaid('${order._id}', 'Ho√†n ti·ªÅn')" style="${btnFull} background-color:#ff7043; box-shadow: 0 4px 6px rgba(255, 112, 67, 0.3);">
            üí∏ X√°c nh·∫≠n ƒë√£ ho√†n ti·ªÅn
        </button>
    `;
        }
        
        // --- ∆ØU TI√äN 2: X·ª¨ L√ù TI·ªÄN THI·∫æU (THU TH√äM) ---
        // N·∫øu c√≤n thi·∫øu ti·ªÅn (chenhLech > 0)
        else if (chenhLech > 0) {
            let bangTinhTien = '';
            
            // A. ƒê√£ tr·∫£ 1 ph·∫ßn -> Hi·ªán b·∫£ng t√≠nh chi ti·∫øt
            if (daTra > 0) {
                bangTinhTien = `
                    <div style="background-color: #fff3cd; padding: 12px; border-radius: 8px; border: 1px solid #ffeeba; margin-bottom: 15px;">
                        <div style="display:flex; justify-content:space-between; color:#555; margin-bottom: 5px;">
                            <span>T·ªïng m√≥n ƒÉn:</span> <strong>${tongTien.toLocaleString()}ƒë</strong>
                        </div>
                        <div style="display:flex; justify-content:space-between; color:#555; border-bottom:1px dashed #ccc; padding-bottom:8px; margin-bottom:8px;">
                            <span>ƒê√£ thanh to√°n:</span> <span>- ${daTra.toLocaleString()}ƒë</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; color:#d32f2f; font-weight:bold; font-size:1.2rem;">
                            <span>C·∫¶N TR·∫¢ TH√äM:</span> <span>${chenhLech.toLocaleString()}ƒë</span>
                        </div>
                    </div>
                `;
            } 
            // B. Ch∆∞a tr·∫£ ƒë·ªìng n√†o -> Hi·ªán t·ªïng ti·ªÅn ƒë∆°n gi·∫£n
            else {
                bangTinhTien = `
                    <div style="${statusTextStyle} color:#d39e00;">
                        ‚ö†Ô∏è Kh√°ch ch∆∞a thanh to√°n <br>
                        <span style="font-size: 1.3rem; color: #333;">${tongTien.toLocaleString()}ƒë</span>
                    </div>
                `;
            }

            buttonsHtml += `
                ${bangTinhTien}
                <button onclick="handleMarkAsPaid('${order._id}', 'Ti·ªÅn m·∫∑t')" style="${btnFull} background-color:#ff7043; box-shadow: 0 4px 6px rgba(255, 112, 67, 0.3);">
                    üí∞ Thanh to√°n ngay
                </button>
            `;
        }
        
        // --- ∆ØU TI√äN 3: TR·∫¢ ƒê·ª¶ -> TR·∫¢ B√ÄN ---
        // Ch·ªâ hi·ªán khi ch√™nh l·ªách = 0 (ƒê√£ ho√†n t·∫•t ti·ªÅn nong)
        else {
            buttonsHtml += `
                <div style="${statusTextStyle} color: #28a745;">
                    ‚úÖ ƒê√£ thanh to√°n xong (${tongTien.toLocaleString()}ƒë)
                </div>
                <button data-action="release-table" style="${btnFull} background-color:#28a745;">
                    üèÅ Tr·∫£ b√†n
                </button>
            `;
        }

        // --- C√ÅC N√öT PH·ª§ (Lu√¥n n·∫±m d∆∞·ªõi c√πng) ---
        // N√∫t In h√≥a ƒë∆°n
        buttonsHtml += btnPrint;
        
        // N√∫t X√≥a ƒë∆°n (Nh·ªè nh·∫•t)
        buttonsHtml += `<div style="text-align:center; margin-top:10px;"><button data-action="delete" style="${outlineGrayStyle}">üóëÔ∏è X√≥a ƒë∆°n</button></div>`;
    }

    return buttonsHtml;
}
// --- 2. H√ÄM G·ªåI API THANH TO√ÅN ---
async function handleMarkAsPaid(orderId, method) {
    if (!confirm(`X√°c nh·∫≠n kh√°ch thanh to√°n b·∫±ng: ${method}?`)) return;
    
    try {
        const response = await fetch(`/api/donhang/mark-paid/${orderId}`, {
            method: 'POST', 
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userInfo.token}` 
            },
            // G·ª≠i ph∆∞∆°ng th·ª©c thanh to√°n l√™n server
            body: JSON.stringify({ paymentMethod: method }) 
        });
        
        if (!response.ok) throw new Error((await response.json()).message);
        
        // C·∫≠p nh·∫≠t l·∫°i modal ngay l·∫≠p t·ª©c ƒë·ªÉ th·∫•y n√∫t "Tr·∫£ b√†n"
        showOrderDetailModal(orderId); 
        
    } catch (err) { alert(`L·ªói: ${err.message}`); }
}
        // 8. G·∫Øn s·ª± ki·ªán cho c√°c n√∫t
        function attachActionEvents(order, container) {
            container.querySelector('[data-action="processing"]')?.addEventListener('click', () => handleUpdateStatus(order._id, 'ƒêang x·ª≠ l√Ω'));
            container.querySelector('[data-action="complete"]')?.addEventListener('click', () => handleUpdateStatus(order._id, 'Ho√†n th√†nh'));
            container.querySelector('[data-action="cancel"]')?.addEventListener('click', () => handleUpdateStatus(order._id, 'ƒê√£ h·ªßy'));
            container.querySelector('[data-action="delete"]')?.addEventListener('click', () => handleDeleteOrder(order._id));
            container.querySelector('[data-action="mark-paid"]')?.addEventListener('click', () => handleMarkAsPaid(order._id));
            container.querySelector('[data-action="release-table"]')?.addEventListener('click', () => handleReleaseTable(order._id));
        }

        // === H√ÄM LOGIC CH√çNH C·ª¶A TRANG ===
        function runPageLogic() {
            // 1. Ki·ªÉm tra Admin
            if (!userInfo || userInfo.role !== 'admin') {
                alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.");
                window.location.href = '/index.html';
                return;
            }

            // 2. C·∫≠p nh·∫≠t n√∫t ƒêƒÉng xu·∫•t V√Ä B·∫¨T C√ÅC N√öT MENU
            const authButton = document.getElementById("authButton");
            if (authButton) {
                authButton.textContent = `ƒêƒÉng xu·∫•t (${userInfo.username || ''})`;
                authButton.addEventListener("click", () => {
                    localStorage.clear();
                    window.location.href = "/index.html";
                });
            }
            
            // ... trong h√†m runPageLogic ...

const navAdminDon = document.getElementById("nav-admin-link"); 
const navAdminBan = document.getElementById("nav-table-link"); 
// üî• 1. TH√äM D√íNG N√ÄY (L·∫•y n√∫t Th·ªëng k√™)
const navStatsLink = document.getElementById("nav-stats-link"); 
const utilityDropdown = document.getElementById("utilityDropdown");

if (navAdminDon) navAdminDon.style.display = "inline-block";
if (navAdminBan) navAdminBan.style.display = "inline-block";
// üî• 2. TH√äM D√íNG N√ÄY (Hi·ªÉn th·ªã n√≥ l√™n)
if (navStatsLink) navStatsLink.style.display = "inline-block"; 
if (utilityDropdown) utilityDropdown.style.display = "inline-block";

            // 3. G·∫Øn s·ª± ki·ªán cho n√∫t ƒë√≥ng Modal
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('orderDetailModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('orderDetailModal')) closeModal();
            });

            // 4. K·∫øt n·ªëi Socket.IO
            try {
           const socket = io('https://web-do-an2.onrender.com');
                socket.on('connect', () => console.log('Admin (B√†n) ƒë√£ k·∫øt n·ªëi Socket.IO'));
                socket.on('new_order', () => loadDataAndRenderMap());
                socket.on('order_updated', () => loadDataAndRenderMap());
                socket.on('order_deleted', () => loadDataAndRenderMap());
                socket.on('banUpdated', () => loadDataAndRenderMap()); 

            } catch (err) { console.error("L·ªói k·∫øt n·ªëi Socket.IO:", err.message); }

            // 5. T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
            loadDataAndRenderMap();
        }

        // === INIT (T·∫¢I NAVBAR V√Ä CH·∫†Y) ===
        document.addEventListener('DOMContentLoaded', () => {
            userInfo = JSON.parse(localStorage.getItem("userInfo"));
            const navbarFile = '/admin-navbar.html';
            
            fetch(navbarFile)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('navbar-placeholder').innerHTML = data;
                    runPageLogic(); // Ch·∫°y logic sau khi t·∫£i menu
                })
                .catch(error => {
                    console.error('L·ªói t·∫£i menu:', error);
                    runPageLogic(); // V·∫´n ch·∫°y d√π menu l·ªói
                });
        });
        // === H√ÄM IN H√ìA ƒê∆†N (M·ªöI TH√äM) ===
async function printBill(orderId) {
    try {
        // 1. L·∫•y th√¥ng tin m·ªõi nh·∫•t c·ªßa ƒë∆°n h√†ng
        const res = await fetch(`/api/donhang/details/${orderId}`, {
            headers: { 'Authorization': `Bearer ${userInfo.token}` }
        });
        const order = await res.json();

        // 2. Chu·∫©n b·ªã d·ªØ li·ªáu t√≠nh to√°n
        const tongTien = parseInt(order.totalPrice) || 0;
        let daTra = parseInt(order.amountPaid) || 0;
        // Fix l·ªói ƒë∆°n c≈© n·∫øu c·∫ßn
        if (order.trangThaiThanhToan === 'ƒê√£ thanh to√°n' && daTra === 0) daTra = tongTien;
        
        const conLai = tongTien - daTra;
        const date = new Date(order.createdAt).toLocaleString('vi-VN');

        // 3. T·∫°o n·ªôi dung HTML cho h√≥a ƒë∆°n (Kh·ªï K80)
        const itemsHtml = order.items.map(item => `
            <tr style="border-bottom: 1px dashed #ccc;">
                <td style="padding: 5px 0;">${item.itemId?.name || 'M√≥n ƒë√£ x√≥a'} <br> <small>x${item.quantity}</small></td>
                <td style="text-align: right;">${((item.itemId?.gia || item.itemId?.price || 0) * item.quantity).toLocaleString()}</td>
            </tr>
        `).join('');

        // 4. M·ªü c·ª≠a s·ªï in
        const printWindow = window.open('', '', 'height=600,width=400');
        printWindow.document.write(`
            <html>
            <head>
                <title>H√≥a ƒê∆°n</title>
                <style>
                    body { font-family: 'Courier New', monospace; font-size: 14px; width: 300px; margin: 0 auto; color: #000; }
                    .header { text-align: center; margin-bottom: 20px; }
                    .header h2 { margin: 0; font-size: 20px; text-transform: uppercase; }
                    table { width: 100%; border-collapse: collapse; }
                    .totals { margin-top: 15px; border-top: 2px solid #000; padding-top: 10px; }
                    .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
                    .bold { font-weight: bold; }
                    .footer { text-align: center; margin-top: 30px; font-style: italic; font-size: 12px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>QU√ÅN ƒÇN NGON</h2>
                    <p>ƒêC: 54 ƒê∆∞·ªùng Nguy·ªÖn L∆∞∆°ng B·∫±ng,TP.ƒê√† N·∫≥ng </p>
                </div>
                <div style="margin-bottom: 15px; font-size: 12px;">
                    <div>Phi·∫øu: #${order._id.slice(-6).toUpperCase()}</div>
                    <div>Ng√†y: ${date}</div>
                    <div>B√†n: <strong>${order.banId?.soBan || 'Mang v·ªÅ'}</strong></div>
                </div>
                <table>
                    <thead>
                        <tr style="border-bottom: 2px solid #000;">
                            <th style="text-align: left;">M√≥n</th>
                            <th style="text-align: right;">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div class="totals">
                    <div class="row bold" style="font-size: 16px;"><span>T·ªîNG C·ªòNG:</span><span>${tongTien.toLocaleString()}ƒë</span></div>
                    ${daTra > 0 ? `<div class="row"><span>ƒê√£ thanh to√°n:</span><span>-${daTra.toLocaleString()}ƒë</span></div>` : ''}
                    ${conLai > 0 ? `<div class="row bold" style="margin-top:5px; border-top:1px dashed #000; padding-top:5px;"><span>C·∫¶N THANH TO√ÅN:</span><span>${conLai.toLocaleString()}ƒë</span></div>` : ''}
                </div>
                <div class="footer"><p>C·∫£m ∆°n qu√Ω kh√°ch!</p></div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);

    } catch (err) { alert("L·ªói in: " + err.message); }
}
    </script>
    <script src="/js/data.js"></script>
</body>
</html>