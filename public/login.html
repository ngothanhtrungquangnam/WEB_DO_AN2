<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Nhập - Quán Ăn Ngon 24h</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Style nhanh cho form đăng nhập */
        body { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background: var(--bg-color); 
        }
        .login-container { 
            background: var(--card-bg); 
            padding: 2.5rem; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            width: 100%; 
            max-width: 400px; 
            text-align: center;
        }
        .login-container h2 { 
            color: var(--main-color); 
            margin-bottom: 1.5rem; 
            font-weight: 600; 
            font-family: "Poppins", sans-serif;
        }
        .login-container input { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 1rem; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 1rem; 
        }
        .login-container label { 
            display: block; 
            text-align: left; 
            margin-bottom: 0.5rem; 
            font-weight: 500; 
            color: var(--text-color);
        }
        .login-container .btn { 
            width: 100%; 
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h2>Đăng Nhập</h2>
        <form id="loginForm">
            <div>
                <label for="username">Tên đăng nhập:</label>
               <input type="text" id="username" required>

            </div>
            <div>
                <label for="password">Mật khẩu:</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn">Đăng Nhập</button>
            <div id="loginError" style="color: #e74c3c; margin-top: 1rem; display: none;"></div>
        </form>
         <p style="margin-top: 1.5rem; color: var(--secondary-text-color);">
            Chưa có tài khoản? <a href="/register.html" style="color: var(--main-color);">Đăng ký ngay</a>
         </p>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        // Chuyển hướng nếu đã đăng nhập
        const existingUserInfo = localStorage.getItem('userInfo');
        if (existingUserInfo) {
             const user = JSON.parse(existingUserInfo);
             window.location.href = user.role === 'admin' ? '/quan-ly-mon-an.html' : '/index.html';
        }

     // DÁN VÀO FILE public/login.html HOẶC public/script.js (tùy theo bạn đặt nó ở đâu)

loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (loginError) loginError.style.display = 'none'; 
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
        if (loginError) {
            loginError.textContent = 'Vui lòng nhập đủ thông tin.';
            loginError.style.display = 'block';
        }
        return;
    }

    try {
        const response = await fetch('/api/auth/login', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        // Chỉ "đọc thư" MỘT LẦN DUY NHẤT ở đây
        const data = await response.json();

       if (response.ok) {
    // ✅ Gộp thông tin user và token lại để lưu
   const userInfo = {
    userId: data.user._id,   // ✅ đổi id → userId
    username: data.user.username,
    role: data.user.role,
    token: data.token
};
localStorage.setItem("userInfo", JSON.stringify(userInfo));


    // ✅ Chuyển hướng tùy vai trò
    if (data.user.role === "admin") {
    window.location.href = "/admin.html";
    } else {
        window.location.href = "/index.html";
    }

} else {
    // Đăng nhập thất bại
    if (loginError) {
        loginError.textContent = data.message || 'Đăng nhập thất bại.';
        loginError.style.display = 'block';
    }
}

    } catch (error) {
        // Lỗi mạng hoặc server sập
        console.error('Login Error:', error);
        if (loginError) {
            loginError.textContent = 'Lỗi kết nối đến máy chủ.';
            loginError.style.display = 'block';
        }
    }
});
    </script>
</body>
</html>