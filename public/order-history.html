<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ ƒë·∫∑t m√≥n</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { background-color: #f4f4f4; margin: 0; padding-bottom: 100px; }
        .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
        h2 { text-align: center; color: #ff7043; margin-bottom: 2rem; }
        .order-card { background: #fff; margin-bottom: 1.5rem; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .order-header { padding: 1rem 1.5rem; background: #fffaf7; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .order-body { padding: 1.5rem; }
        .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .order-footer { padding: 1rem 1.5rem; background: #f9f9f9; text-align: right; font-size: 1.2rem; font-weight: bold; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; }
        .status-completed { background-color: #e8f5e9; color: #4caf50; }
        .status-cancelled { background-color: #ffebee; color: #f44336; }
        
        /* üî• Th√™m d√≤ng n√†y ƒë·ªÉ th·∫Øp s√°ng ti·ªán √≠ch */
        .nav-item.active i { color: #ff6b6b !important; }
    </style>
</head>
<body>

    <div id="navbar-placeholder"></div>

    <main class="container">
        <h2>L·ªãch s·ª≠ ƒê·∫∑t m√≥n </h2>
        <div id="order-list-container">
            <p style="text-align: center;">ƒêang t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng...</p>
        </div>
    </main>
    
    <div id="bottom-nav-placeholder"></div>

    <script>
        let userInfo = null;
        function formatCurrency(n) { return new Intl.NumberFormat('vi-VN', {style:'currency',currency:'VND'}).format(n); }

        async function loadOrderHistory() {
            userInfo = JSON.parse(localStorage.getItem("userInfo")); // C·∫≠p nh·∫≠t l·∫°i userInfo
            const container = document.getElementById('order-list-container');
            const token = userInfo?.token;
            if (!token) { container.innerHTML = '<p style="text-align: center; color: red;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.</p>'; return; }
            try {
                const res = await fetch(`/api/donhang/my-orders?userId=${userInfo.userId||userInfo._id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const all = await res.json();
                const finished = all.filter(o => o.status === 'Ho√†n th√†nh' || o.status === 'ƒê√£ h·ªßy');
                if (!finished.length) { container.innerHTML = '<p style="text-align:center">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>'; return; }
                
                finished.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
                container.innerHTML = finished.map(o => `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <strong>M√£: ${o._id.substring(0,8)}...</strong><br>
                                <small>${new Date(o.createdAt).toLocaleString('vi-VN')}</small>
                            </div>
                            <span class="status ${o.status==='Ho√†n th√†nh'?'status-completed':'status-cancelled'}">${o.status}</span>
                        </div>
                        <div class="order-body">
                            ${o.items.map(i=>`<div class="order-item"><span>${i.itemId?.name||'M√≥n x√≥a'} (x${i.quantity})</span><span>${formatCurrency((i.itemId?.price||0)*i.quantity)}</span></div>`).join('')}
                        </div>
                        <div class="order-footer">T·ªïng: ${formatCurrency(o.totalPrice)}</div>
                    </div>
                `).join('');
            } catch (e) { container.innerHTML = '<p style="text-align:center">L·ªói t·∫£i d·ªØ li·ªáu.</p>'; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            userInfo = JSON.parse(localStorage.getItem("userInfo"));
            
            // T·∫£i Navbar tr√™n
            let nav = userInfo?.role==='admin' ? 'admin-navbar.html' : (!userInfo ? 'guest-navbar.html' : 'user-navbar.html');
            fetch(nav).then(r=>r.text()).then(h=>document.getElementById('navbar-placeholder').innerHTML=h);

            loadOrderHistory();
        });
    </script>

    <script src="script.js"></script> 
</body>
</html>